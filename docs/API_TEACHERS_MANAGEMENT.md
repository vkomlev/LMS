# API для управления преподавателями

Полная документация по всем эндпойнтам API для управления преподавателями в системе LMS.

## Содержание

1. [CRUD операции](#crud-операции)
2. [Поиск и фильтрация](#поиск-и-фильтрация)
3. [Привязка к студентам](#привязка-к-студентам)
4. [Привязка к курсам](#привязка-к-курсам)
5. [Схемы данных](#схемы-данных)
6. [Коды ответов](#коды-ответов)
7. [Примеры использования](#примеры-использования)

---

## CRUD операции

Преподаватели в системе - это пользователи с ролью `teacher`. Все CRUD операции выполняются через эндпойнты `/api/v1/users/` с фильтрацией по роли.

### 1. GET /api/v1/users/ - Список преподавателей

**Описание:** Получить список преподавателей с поддержкой пагинации, сортировки и фильтрации по роли.

**URL:** `/api/v1/users/`

**Метод:** `GET`

**Параметры запроса:**

| Параметр | Тип | Обязательный | Описание | Примеры |
|----------|-----|--------------|----------|---------|
| `skip` | `int` | Нет | Смещение для пагинации (сколько записей пропустить) | `0`, `10`, `50` |
| `limit` | `int` | Нет | Максимум результатов на странице (от 1 до 1000) | `10`, `50`, `100` |
| `sort_by` | `enum` | Нет | Поле для сортировки: `full_name`, `email`, `created_at` | `full_name`, `email` |
| `order` | `enum` | Нет | Направление сортировки: `asc` или `desc` | `asc`, `desc` |
| `role` | `string` | Нет | Фильтр по роли по имени. Для преподавателей: `teacher` | `teacher`, `student` |
| `api_key` | `string` | Да | API ключ для аутентификации | `bot-key-1` |

**Пример запроса:**

```bash
# Получить всех преподавателей, отсортированных по ФИО
GET /api/v1/users/?role=teacher&sort_by=full_name&order=asc&api_key=bot-key-1

# Получить последних зарегистрированных преподавателей
GET /api/v1/users/?role=teacher&sort_by=created_at&order=desc&limit=10&api_key=bot-key-1

# Вторая страница (по 50 записей)
GET /api/v1/users/?role=teacher&skip=50&limit=50&api_key=bot-key-1
```

**Ответ (200 OK):**

```json
{
  "items": [
    {
      "id": 16,
      "email": "teacher_1@example.com",
      "full_name": "Преподаватель Тестовый 1",
      "tg_id": null,
      "created_at": "2026-01-26T14:21:50.253Z"
    },
    {
      "id": 17,
      "email": "teacher_2@example.com",
      "full_name": "Преподаватель Тестовый 2",
      "tg_id": 123456789,
      "created_at": "2026-01-26T14:22:10.123Z"
    }
  ],
  "meta": {
    "total": 2,
    "limit": 50,
    "offset": 0
  }
}
```

**Коды ответов:**

| Код | Описание | Причина |
|-----|----------|---------|
| `200` | Успешно | Список преподавателей успешно получен |
| `403` | Forbidden | Неверный или отсутствующий API ключ |
| `422` | Unprocessable Entity | Ошибка валидации параметров (неверный тип или значение) |

**Особенности:**
- Сортировка по умолчанию: `full_name ASC` (алфавитный порядок)
- NULL значения в полях сортировки всегда идут в конец списка
- Фильтрация по роли выполняется по имени роли (регистр не важен)
- Если указана несуществующая роль, возвращается пустой список

---

### 2. POST /api/v1/users/ - Создание преподавателя

**Описание:** Создать нового преподавателя в системе.

**URL:** `/api/v1/users/`

**Метод:** `POST`

**Параметры запроса:**

| Параметр | Тип | Обязательный | Описание |
|----------|-----|--------------|----------|
| `api_key` | `string` | Да | API ключ для аутентификации |

**Тело запроса:**

| Поле | Тип | Обязательное | Описание | Примеры |
|------|-----|--------------|----------|---------|
| `email` | `EmailStr` | Да | Email преподавателя (уникальный) | `teacher@example.com` |
| `full_name` | `string` | Нет | Полное имя преподавателя | `Иван Иванов` |
| `tg_id` | `int` | Нет | Telegram ID преподавателя | `123456789` |

**Пример запроса:**

```bash
POST /api/v1/users/?api_key=bot-key-1
Content-Type: application/json

{
  "email": "new_teacher@example.com",
  "full_name": "Новый Преподаватель",
  "tg_id": 987654321
}
```

**Ответ (201 Created):**

```json
{
  "id": 18,
  "email": "new_teacher@example.com",
  "full_name": "Новый Преподаватель",
  "tg_id": 987654321,
  "created_at": "2026-01-26T15:30:00.000Z"
}
```

**Коды ответов:**

| Код | Описание | Причина |
|-----|----------|---------|
| `201` | Created | Преподаватель успешно создан |
| `400` | Bad Request | Email уже существует или неверный формат данных |
| `403` | Forbidden | Неверный или отсутствующий API ключ |
| `422` | Unprocessable Entity | Ошибка валидации данных |

**Примечания:**
- Email должен быть уникальным в системе
- Email должен быть валидным (формат проверяется автоматически)
- После создания пользователя необходимо назначить ему роль `teacher` через соответствующий эндпойнт управления ролями

---

### 3. GET /api/v1/users/{id} - Получение преподавателя

**Описание:** Получить информацию о конкретном преподавателе по его ID.

**URL:** `/api/v1/users/{id}`

**Метод:** `GET`

**Параметры пути:**

| Параметр | Тип | Обязательный | Описание | Примеры |
|----------|-----|--------------|----------|---------|
| `id` | `int` | Да | ID преподавателя | `16`, `17` |

**Параметры запроса:**

| Параметр | Тип | Обязательный | Описание |
|----------|-----|--------------|----------|
| `api_key` | `string` | Да | API ключ для аутентификации |

**Пример запроса:**

```bash
GET /api/v1/users/16?api_key=bot-key-1
```

**Ответ (200 OK):**

```json
{
  "id": 16,
  "email": "teacher_1@example.com",
  "full_name": "Преподаватель Тестовый 1",
  "tg_id": null,
  "created_at": "2026-01-26T14:21:50.253Z"
}
```

**Коды ответов:**

| Код | Описание | Причина |
|-----|----------|---------|
| `200` | Успешно | Преподаватель найден |
| `404` | Not Found | Преподаватель с указанным ID не найден |
| `403` | Forbidden | Неверный или отсутствующий API ключ |

---

### 4. PATCH /api/v1/users/{id} - Обновление преподавателя

**Описание:** Частично обновить данные преподавателя. Можно обновить одно или несколько полей.

**URL:** `/api/v1/users/{id}`

**Метод:** `PATCH`

**Параметры пути:**

| Параметр | Тип | Обязательный | Описание | Примеры |
|----------|-----|--------------|----------|---------|
| `id` | `int` | Да | ID преподавателя | `16`, `17` |

**Параметры запроса:**

| Параметр | Тип | Обязательный | Описание |
|----------|-----|--------------|----------|
| `api_key` | `string` | Да | API ключ для аутентификации |

**Тело запроса:**

Все поля опциональны. Обновляются только переданные поля:

| Поле | Тип | Обязательное | Описание | Примеры |
|------|-----|--------------|----------|---------|
| `email` | `EmailStr` | Нет | Email преподавателя (валидный email) | `newemail@example.com` |
| `full_name` | `string` | Нет | Полное имя преподавателя | `Обновленное Имя` |
| `tg_id` | `int` | Нет | Telegram ID преподавателя | `987654321` |

**Пример запроса:**

```bash
# Обновить только имя
PATCH /api/v1/users/16?api_key=bot-key-1
Content-Type: application/json

{
  "full_name": "Обновленное Имя Преподавателя"
}

# Обновить email и имя
PATCH /api/v1/users/16?api_key=bot-key-1
Content-Type: application/json

{
  "email": "newemail@example.com",
  "full_name": "Обновленное Имя"
}

# Обновить только Telegram ID
PATCH /api/v1/users/16?api_key=bot-key-1
Content-Type: application/json

{
  "tg_id": 987654321
}
```

**Ответ (200 OK):**

```json
{
  "id": 16,
  "email": "newemail@example.com",
  "full_name": "Обновленное Имя Преподавателя",
  "tg_id": 987654321,
  "created_at": "2026-01-26T14:21:50.253Z"
}
```

**Коды ответов:**

| Код | Описание | Причина |
|-----|----------|---------|
| `200` | Успешно | Преподаватель успешно обновлен |
| `404` | Not Found | Преподаватель с указанным ID не найден |
| `403` | Forbidden | Неверный или отсутствующий API ключ |
| `422` | Unprocessable Entity | Ошибка валидации данных (неверный формат email и т.д.) |

**Особенности:**
- Все поля опциональны (частичное обновление)
- Обновляются только переданные поля
- Поля, которые не переданы, остаются без изменений
- Email должен быть уникальным в системе (если обновляется)
- Email должен быть валидным (формат проверяется автоматически)

---

### 5. DELETE /api/v1/users/{id} - Удаление преподавателя

**Описание:** Удалить преподавателя из системы.

**URL:** `/api/v1/users/{id}`

**Метод:** `DELETE`

**Параметры пути:**

| Параметр | Тип | Обязательный | Описание | Примеры |
|----------|-----|--------------|----------|---------|
| `id` | `int` | Да | ID преподавателя | `16`, `17` |

**Параметры запроса:**

| Параметр | Тип | Обязательный | Описание |
|----------|-----|--------------|----------|
| `api_key` | `string` | Да | API ключ для аутентификации |

**Пример запроса:**

```bash
DELETE /api/v1/users/16?api_key=bot-key-1
```

**Ответ (204 No Content):**

Тело ответа отсутствует.

**Коды ответов:**

| Код | Описание | Причина |
|-----|----------|---------|
| `204` | No Content | Преподаватель успешно удален |
| `404` | Not Found | Преподаватель с указанным ID не найден |
| `403` | Forbidden | Неверный или отсутствующий API ключ |

**Примечания:**
- При удалении преподавателя автоматически удаляются все его связи со студентами и курсами (через CASCADE в БД)

---

## Поиск и фильтрация

### 6. GET /api/v1/users/search - Поиск преподавателей по имени

**Описание:** Поиск пользователей по фрагменту имени (поля `full_name`) с опциональной фильтрацией по роли (например, преподаватели/студенты/методисты).

**URL:** `/api/v1/users/search`

**Метод:** `GET`

**Параметры запроса:**

| Параметр | Тип | Обязательный | Описание | Примеры |
|----------|-----|--------------|----------|---------|
| `q` | `string` | Да | Фрагмент имени для поиска (минимум 2 символа) | `Иван`, `Петр`, `test` |
| `role` | `string` | Нет | Фильтр по роли по имени (case-insensitive): `teacher`, `student`, `methodist` | `teacher`, `student`, `methodist` |
| `limit` | `int` | Нет | Максимум результатов (от 1 до 200) | `10`, `20`, `50` |
| `offset` | `int` | Нет | Смещение для пагинации | `0`, `10`, `20` |
| `api_key` | `string` | Да | API ключ для аутентификации | `bot-key-1` |

**Пример запроса:**

```bash
# Поиск преподавателей с именем, содержащим "Иван"
GET /api/v1/users/search?q=Иван&role=teacher&api_key=bot-key-1

# Поиск студентов с именем, содержащим "Иван"
GET /api/v1/users/search?q=Иван&role=student&api_key=bot-key-1

# Поиск методистов с именем, содержащим "Иван"
GET /api/v1/users/search?q=Иван&role=methodist&api_key=bot-key-1

# Поиск с ограничением результатов
GET /api/v1/users/search?q=test&role=teacher&limit=10&api_key=bot-key-1
```

**Ответ (200 OK):**

```json
[
  {
    "id": 16,
    "email": "teacher_1@example.com",
    "full_name": "Иван Преподаватель",
    "tg_id": null,
    "created_at": "2026-01-26T14:21:50.253Z"
  }
]
```

**Коды ответов:**

| Код | Описание | Причина |
|-----|----------|---------|
| `200` | Успешно | Поиск выполнен успешно |
| `400` | Bad Request | Запрос слишком короткий (менее 2 символов) |
| `403` | Forbidden | Неверный или отсутствующий API ключ |
| `422` | Unprocessable Entity | Ошибка валидации параметров |

**Особенности:**
- Поиск нечувствителен к регистру (case-insensitive)
- Поиск выполняется по шаблону `ILIKE %q%` (содержит подстроку)
- Фильтрация по роли выполняется по имени роли (без учета регистра)
- Результаты автоматически сортируются по `full_name` ASC
- Минимальная длина запроса: 2 символа
- Если `role` не указан — возвращаются пользователи всех ролей, подходящие под поиск

---

### 7. GET /api/v1/users/by-tg/{tg_id} - Получить ID преподавателя по Telegram ID

**Описание:** Найти преподавателя по его Telegram ID и вернуть только его ID в системе.

**URL:** `/api/v1/users/by-tg/{tg_id}`

**Метод:** `GET`

**Параметры пути:**

| Параметр | Тип | Обязательный | Описание | Примеры |
|----------|-----|--------------|----------|---------|
| `tg_id` | `int` | Да | Telegram ID преподавателя | `123456789`, `987654321` |

**Параметры запроса:**

| Параметр | Тип | Обязательный | Описание |
|----------|-----|--------------|----------|
| `api_key` | `string` | Да | API ключ для аутентификации |

**Пример запроса:**

```bash
GET /api/v1/users/by-tg/123456789?api_key=bot-key-1
```

**Ответ (200 OK):**

```json
{
  "id": 16
}
```

**Коды ответов:**

| Код | Описание | Причина |
|-----|----------|---------|
| `200` | Успешно | Преподаватель найден |
| `404` | Not Found | Преподаватель с указанным Telegram ID не найден |
| `403` | Forbidden | Неверный или отсутствующий API ключ |

**Пример ошибки (404):**

```json
{
  "detail": "User with tg_id=123456789 not found"
}
```

---

## Привязка к студентам

### 8. GET /api/v1/users/{teacher_id}/students - Список студентов преподавателя

**Описание:** Получить список всех студентов, привязанных к указанному преподавателю.

**URL:** `/api/v1/users/{teacher_id}/students`

**Метод:** `GET`

**Параметры пути:**

| Параметр | Тип | Обязательный | Описание | Примеры |
|----------|-----|--------------|----------|---------|
| `teacher_id` | `int` | Да | ID преподавателя | `16`, `17` |

**Параметры запроса:**

| Параметр | Тип | Обязательный | Описание |
|----------|-----|--------------|----------|
| `api_key` | `string` | Да | API ключ для аутентификации |

**Пример запроса:**

```bash
GET /api/v1/users/16/students?api_key=bot-key-1
```

**Ответ (200 OK):**

```json
[
  {
    "id": 13,
    "email": "student_1@example.com",
    "full_name": "Студент Тестовый 1",
    "tg_id": null,
    "created_at": "2026-01-26T14:21:50.221Z"
  },
  {
    "id": 14,
    "email": "student_2@example.com",
    "full_name": "Студент Тестовый 2",
    "tg_id": null,
    "created_at": "2026-01-26T14:21:50.249Z"
  }
]
```

**Коды ответов:**

| Код | Описание | Причина |
|-----|----------|---------|
| `200` | Успешно | Список студентов успешно получен (может быть пустым) |
| `404` | Not Found | Преподаватель с указанным ID не найден |
| `403` | Forbidden | Неверный или отсутствующий API ключ |

**Примечания:**
- Если у преподавателя нет привязанных студентов, возвращается пустой массив `[]`
- Связь создается в обе стороны (студент видит преподавателя, преподаватель видит студента)

---

### 9. POST /api/v1/users/{student_id}/teachers/{teacher_id} - Привязать преподавателя к студенту

**Описание:** Привязать преподавателя к студенту.

**URL:** `/api/v1/users/{student_id}/teachers/{teacher_id}`

**Метод:** `POST`

**Параметры пути:**

| Параметр | Тип | Обязательный | Описание | Примеры |
|----------|-----|--------------|----------|---------|
| `student_id` | `int` | Да | ID студента | `13`, `14` |
| `teacher_id` | `int` | Да | ID преподавателя | `16`, `17` |

**Параметры запроса:**

| Параметр | Тип | Обязательный | Описание |
|----------|-----|--------------|----------|
| `api_key` | `string` | Да | API ключ для аутентификации |

**Пример запроса:**

```bash
POST /api/v1/users/13/teachers/16?api_key=bot-key-1
```

**Ответ (204 No Content):**

Тело ответа отсутствует.

**Коды ответов:**

| Код | Описание | Причина |
|-----|----------|---------|
| `204` | No Content | Связь успешно создана (или уже существовала) |
| `404` | Not Found | Студент или преподаватель не найден |
| `403` | Forbidden | Неверный или отсутствующий API ключ |

**Особенности:**
- Связь создается в обе стороны (студент видит преподавателя, преподаватель видит студента)
- Если связь уже существует, операция выполняется без ошибки (idempotent)
- Оба пользователя должны существовать в системе
- После создания связи студент появится в списке студентов преподавателя

---

### 10. DELETE /api/v1/users/{student_id}/teachers/{teacher_id} - Отвязать преподавателя от студента

**Описание:** Удалить связь между студентом и преподавателем.

**URL:** `/api/v1/users/{student_id}/teachers/{teacher_id}`

**Метод:** `DELETE`

**Параметры пути:**

| Параметр | Тип | Обязательный | Описание | Примеры |
|----------|-----|--------------|----------|---------|
| `student_id` | `int` | Да | ID студента | `13`, `14` |
| `teacher_id` | `int` | Да | ID преподавателя | `16`, `17` |

**Параметры запроса:**

| Параметр | Тип | Обязательный | Описание |
|----------|-----|--------------|----------|
| `api_key` | `string` | Да | API ключ для аутентификации |

**Пример запроса:**

```bash
DELETE /api/v1/users/13/teachers/16?api_key=bot-key-1
```

**Ответ (204 No Content):**

Тело ответа отсутствует.

**Коды ответов:**

| Код | Описание | Причина |
|-----|----------|---------|
| `204` | No Content | Связь успешно удалена (или не существовала) |
| `403` | Forbidden | Неверный или отсутствующий API ключ |

**Особенности:**
- Операция идемпотентна: если связи не было, возвращается 204 без ошибки
- Связь удаляется в обе стороны
- После удаления связи студент исчезнет из списка студентов преподавателя

---

## Привязка к курсам

Подробная документация по привязке преподавателей к курсам находится в отдельном файле: **[API_TEACHER_COURSES.md](./API_TEACHER_COURSES.md)**

### Краткий обзор эндпойнтов:

1. **GET /api/v1/users/{teacher_id}/courses** - Список курсов преподавателя
2. **GET /api/v1/courses/{course_id}/teachers** - Список преподавателей курса
3. **POST /api/v1/courses/{course_id}/teachers/{teacher_id}** - Привязать преподавателя к курсу
4. **DELETE /api/v1/courses/{course_id}/teachers/{teacher_id}** - Отвязать преподавателя от курса
5. **GET /api/v1/teacher-courses/** - Список всех связей преподаватель ↔ курс (с фильтрацией)
6. **POST /api/v1/teacher-courses/** - Создать связь преподаватель ↔ курс (RESTful)
7. **DELETE /api/v1/teacher-courses/{teacher_id}/{course_id}** - Удалить связь преподаватель ↔ курс (RESTful)

**Важные особенности:**
- ⚠️ При привязке преподавателя к родительскому курсу, триггер БД автоматически привяжет всех детей курса
- ⚠️ При отвязке преподавателя от родительского курса, триггер БД автоматически отвяжет всех детей курса
- При изменении иерархии курсов связи преподавателей синхронизируются автоматически

---

### 11. GET /api/v1/users/{user_id}/courses - Получить список курсов пользователя

**Описание:** Получить список курсов пользователя с информацией о курсах. Поддерживает пользователей с несколькими ролями одновременно (преподаватель и студент).

**URL:** `/api/v1/users/{user_id}/courses`

**Метод:** `GET`

**Параметры пути:**

| Параметр | Тип | Обязательный | Описание | Примеры |
|----------|-----|--------------|----------|---------|
| `user_id` | `int` | Да | ID пользователя (преподавателя или студента) | `2`, `16`, `17` |

**Параметры запроса:**

| Параметр | Тип | Обязательный | Описание | Примеры |
|----------|-----|--------------|----------|---------|
| `role` | `string` | Нет | Фильтр по роли: `teacher` - только курсы преподавателя, `student` - только курсы студента. Если не указан - возвращаются курсы из обеих таблиц | `teacher`, `student` |
| `order_by_order` | `bool` | Нет | Сортировать по order_number (True) или по added_at (False). По умолчанию: `True` | `true`, `false` |
| `api_key` | `string` | Да | API ключ для аутентификации | `bot-key-1` |

**Особенности:**
- Пользователь может быть одновременно и преподавателем, и студентом
- Если параметр `role` не указан - возвращаются курсы из обеих таблиц (`teacher_courses` и `user_courses`) в объединенном списке
- Если параметр `role=teacher` - возвращаются только курсы преподавателя из таблицы `teacher_courses`
- Если параметр `role=student` - возвращаются только курсы студента из таблицы `user_courses`
- Для преподавателей поле `order_number` всегда `null` (у преподавателей нет порядкового номера)
- Для студентов поле `order_number` может быть задано (порядковый номер курса у студента)
- При объединении списков сортировка выполняется по дате (`added_at` для студентов, `linked_at` для преподавателей)

**Примеры запросов:**

```bash
# Получить все курсы пользователя (и как преподавателя, и как студента)
GET /api/v1/users/2/courses?api_key=bot-key-1

# Получить только курсы преподавателя
GET /api/v1/users/2/courses?role=teacher&api_key=bot-key-1

# Получить только курсы студента
GET /api/v1/users/2/courses?role=student&api_key=bot-key-1

# Получить курсы преподавателя, отсортированные по дате привязки (старые сначала)
GET /api/v1/users/2/courses?role=teacher&order_by_order=false&api_key=bot-key-1

# Получить все курсы, отсортированные по дате (новые сначала)
GET /api/v1/users/2/courses?order_by_order=true&api_key=bot-key-1
```

**Ответ (200 OK):**

```json
{
  "user_id": 2,
  "courses": [
    {
      "user_id": 2,
      "course_id": 18,
      "added_at": "2026-01-27T12:27:23.296645Z",
      "order_number": null,
      "course": {
        "id": 18,
        "title": "Python для ОГЭ",
        "access_level": "auto_check",
        "description": "Курс по Python для подготовки к ОГЭ",
        "parent_course_ids": [],
        "created_at": "2026-01-20T10:00:00Z",
        "is_required": false,
        "course_uid": "COURSE-PY-OGE"
      }
    },
    {
      "user_id": 2,
      "course_id": 88,
      "added_at": "2026-01-27T12:27:23.296645Z",
      "order_number": null,
      "course": {
        "id": 88,
        "title": "ОГЭ",
        "access_level": "auto_check",
        "description": "Общий курс подготовки к ОГЭ",
        "parent_course_ids": [],
        "created_at": "2026-01-20T10:00:00Z",
        "is_required": false,
        "course_uid": "COURSE-OGE"
      }
    }
  ]
}
```

**Структура ответа:**

- `user_id` (int): ID пользователя
- `courses` (array): Массив объектов `UserCourseWithCourse` с информацией о курсах
  - `user_id` (int): ID пользователя
  - `course_id` (int): ID курса
  - `added_at` (datetime): Дата и время привязки (для преподавателей это `linked_at`, для студентов - `added_at`)
  - `order_number` (int | null): Порядковый номер курса у пользователя (для студентов) или `null` (для преподавателей)
  - `course` (object): Полная информация о курсе (объект `CourseRead`)

**Коды ответов:**

| Код | Описание | Причина |
|-----|----------|---------|
| `200` | Успешно | Список курсов успешно получен |
| `400` | Bad Request | Некорректное значение параметра `role` (должно быть `teacher` или `student`) |
| `404` | Not Found | Пользователь с указанным ID не найден |
| `403` | Forbidden | Неверный или отсутствующий API ключ |

**Пример ошибки (400):**

```json
{
  "detail": "Некорректное значение параметра role: 'invalid'. Допустимые значения: 'teacher', 'student'"
}
```

**Пример ошибки (404):**

```json
{
  "detail": "Пользователь с ID 999 не найден"
}
```

**Примечания:**
- Если у пользователя нет курсов ни как преподавателя, ни как студента, возвращается пустой массив `courses: []`
- Параметр `role` поддерживает как английские (`teacher`, `student`), так и русские (`преподаватель`, `студент`) названия ролей
- При объединении списков курсы сортируются по дате (`added_at`), независимо от `order_by_order` для отдельных таблиц

---

## Схемы данных

### UserRead

Схема для чтения информации о преподавателе:

```json
{
  "id": 16,
  "email": "teacher@example.com",
  "full_name": "Иван Иванов",
  "tg_id": 123456789,
  "created_at": "2026-01-26T14:21:50.253Z"
}
```

**Поля:**

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | `int` | ID преподавателя в системе |
| `email` | `EmailStr` | Email преподавателя |
| `full_name` | `string \| null` | Полное имя преподавателя |
| `tg_id` | `int \| null` | Telegram ID преподавателя |
| `created_at` | `datetime` | Дата и время регистрации преподавателя |

### UserCreate

Схема для создания преподавателя:

```json
{
  "email": "teacher@example.com",
  "full_name": "Иван Иванов",
  "tg_id": 123456789
}
```

**Поля:**

| Поле | Тип | Обязательное | Описание |
|------|-----|--------------|----------|
| `email` | `EmailStr` | Да | Email преподавателя (уникальный) |
| `full_name` | `string` | Нет | Полное имя преподавателя |
| `tg_id` | `int` | Нет | Telegram ID преподавателя |

### UserUpdate

Схема для обновления преподавателя (частичное обновление - все поля опциональны):

```json
{
  "email": "newemail@example.com",
  "full_name": "Обновленное Имя",
  "tg_id": 987654321
}
```

**Поля:**

| Поле | Тип | Обязательное | Описание |
|------|-----|--------------|----------|
| `email` | `EmailStr` | Нет | Email преподавателя |
| `full_name` | `string` | Нет | Полное имя преподавателя |
| `tg_id` | `int` | Нет | Telegram ID преподавателя |

### Page[T]

Схема для пагинированных списков:

```json
{
  "items": [...],
  "meta": {
    "total": 100,
    "limit": 50,
    "offset": 0
  }
}
```

**Поля:**

| Поле | Тип | Описание |
|------|-----|----------|
| `items` | `T[]` | Массив элементов текущей страницы |
| `meta` | `object` | Метаданные пагинации |
| `meta.total` | `int` | Общее количество записей (без учета limit/offset) |
| `meta.limit` | `int` | Лимит на страницу |
| `meta.offset` | `int` | Смещение (skip) |

---

## Коды ответов

### Общие коды ответов

| Код | Описание | Когда используется |
|-----|----------|-------------------|
| `200` | OK | Успешный запрос с возвратом данных |
| `201` | Created | Ресурс успешно создан |
| `204` | No Content | Успешный запрос без возврата данных (удаление, создание связи) |
| `400` | Bad Request | Неверный формат запроса или данных |
| `403` | Forbidden | Неверный или отсутствующий API ключ |
| `404` | Not Found | Ресурс не найден |
| `422` | Unprocessable Entity | Ошибка валидации данных или параметров |

### Специфичные коды для операций

**CRUD операции:**
- `200` - Успешное получение/обновление
- `201` - Успешное создание
- `204` - Успешное удаление
- `404` - Ресурс не найден
- `422` - Ошибка валидации

**Поиск:**
- `200` - Поиск выполнен успешно
- `400` - Запрос слишком короткий (менее 2 символов)
- `422` - Ошибка валидации параметров

**Привязка к студентам/курсам:**
- `204` - Связь успешно создана/удалена
- `404` - Студент/преподаватель/курс не найден

---

## Примеры использования

### Сценарий 1: Создание нового преподавателя и назначение ему студентов

```bash
# 1. Создать преподавателя
POST /api/v1/users/?api_key=bot-key-1
Content-Type: application/json

{
  "email": "new_teacher@example.com",
  "full_name": "Новый Преподаватель",
  "tg_id": 123456789
}

# Ответ: {"id": 18, ...}

# 2. Назначить роль teacher (через эндпойнт управления ролями)
# POST /api/v1/users/18/roles/...

# 3. Привязать студентов к преподавателю
POST /api/v1/users/13/teachers/18?api_key=bot-key-1
POST /api/v1/users/14/teachers/18?api_key=bot-key-1

# 4. Проверить список студентов преподавателя
GET /api/v1/users/18/students?api_key=bot-key-1
```

### Сценарий 2: Поиск преподавателя и получение его курсов

```bash
# 1. Найти преподавателя по имени
GET /api/v1/users/search?q=Иван&api_key=bot-key-1

# Ответ: [{"id": 16, "full_name": "Иван Преподаватель", ...}]

# 2. Получить список курсов преподавателя
GET /api/v1/users/16/courses?api_key=bot-key-1

# 3. Получить список студентов преподавателя
GET /api/v1/users/16/students?api_key=bot-key-1
```

### Сценарий 3: Обновление данных преподавателя

```bash
# Обновить email и имя преподавателя
PATCH /api/v1/users/16?api_key=bot-key-1
Content-Type: application/json

{
  "email": "updated_email@example.com",
  "full_name": "Обновленное Имя"
}
```

### Сценарий 4: Получение списка всех преподавателей с фильтрацией и сортировкой

```bash
# Получить всех преподавателей, отсортированных по дате регистрации (новые первые)
GET /api/v1/users/?role=teacher&sort_by=created_at&order=desc&limit=50&api_key=bot-key-1

# Получить преподавателей, отсортированных по email
GET /api/v1/users/?role=teacher&sort_by=email&order=asc&api_key=bot-key-1

# Получить вторую страницу (по 20 записей)
GET /api/v1/users/?role=teacher&skip=20&limit=20&api_key=bot-key-1
```

### Сценарий 5: Управление связями преподаватель-студент

```bash
# 1. Привязать студента к преподавателю
POST /api/v1/users/13/teachers/16?api_key=bot-key-1

# 2. Проверить список студентов преподавателя
GET /api/v1/users/16/students?api_key=bot-key-1

# 3. Отвязать студента от преподавателя
DELETE /api/v1/users/13/teachers/16?api_key=bot-key-1
```

---

## FAQ

### Как получить только преподавателей из списка пользователей?

Используйте параметр `role=teacher` в запросе `GET /api/v1/users/`:

```bash
GET /api/v1/users/?role=teacher&api_key=bot-key-1
```

### Как найти преподавателя по имени?

Используйте эндпойнт поиска `GET /api/v1/users/search`:

```bash
GET /api/v1/users/search?q=Иван&api_key=bot-key-1
```

⚠️ **Важно:** Поиск возвращает всех пользователей с подходящим именем. Для получения только преподавателей используйте фильтрацию по роли в основном списке.

### Как создать преподавателя и сразу назначить ему роль?

1. Создайте пользователя через `POST /api/v1/users/`
2. Назначьте роль `teacher` через эндпойнт управления ролями (например, `POST /api/v1/users/{id}/roles/{role_id}`)

### Что происходит при удалении преподавателя?

При удалении преподавателя автоматически удаляются все его связи:
- Со студентами (через CASCADE в БД)
- С курсами (через CASCADE в БД)

### Можно ли обновить только одно поле преподавателя?

Да, используйте `PATCH /api/v1/users/{id}` с передачей только нужных полей:

```bash
PATCH /api/v1/users/16?api_key=bot-key-1
Content-Type: application/json

{
  "full_name": "Новое Имя"
}
```

### Как получить список всех студентов преподавателя?

Используйте эндпойнт `GET /api/v1/users/{teacher_id}/students`:

```bash
GET /api/v1/users/16/students?api_key=bot-key-1
```

### Как получить список всех курсов преподавателя?

Используйте эндпойнт `GET /api/v1/users/{teacher_id}/courses`. Подробнее см. [API_TEACHER_COURSES.md](./API_TEACHER_COURSES.md).

### Что происходит при привязке преподавателя к родительскому курсу?

Триггер БД автоматически привязывает всех детей курса к преподавателю. Подробнее см. [API_TEACHER_COURSES.md](./API_TEACHER_COURSES.md).

---

## Связанная документация

- **[API_TEACHER_COURSES.md](./API_TEACHER_COURSES.md)** - Подробная документация по привязке преподавателей к курсам
- **[API_STUDENTS_MANAGEMENT.md](./API_STUDENTS_MANAGEMENT.md)** - Документация по управлению студентами
- **[database-triggers-contract.md](./database-triggers-contract.md)** - Контракт по триггерам БД

---

**Последнее обновление:** 2026-01-27
