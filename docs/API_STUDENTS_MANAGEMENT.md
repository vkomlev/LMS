# API документация: Управление студентами

**Версия API:** v1  
**Базовый URL:** `http://localhost:8000/api/v1`  
**Дата обновления:** 27 января 2026

## Быстрая навигация

### Основные эндпойнты для работы со студентами:

1. **Список студентов с сортировкой и фильтрацией**
   - `GET /api/v1/users/?role=student&sort_by=full_name&order=asc` - получить всех студентов, отсортированных по ФИО

2. **Поиск студентов**
   - `GET /api/v1/users/search?q=Иван` - поиск по имени

3. **Связь студент-преподаватель**
   - `GET /api/v1/users/{student_id}/teachers` - список преподавателей студента
   - `POST /api/v1/users/{student_id}/teachers/{teacher_id}` - привязать преподавателя
   - `DELETE /api/v1/users/{student_id}/teachers/{teacher_id}` - отвязать преподавателя

4. **Связь студент-курс**
   - `POST /api/v1/user-courses/` - привязать студента к курсу
   - `DELETE /api/v1/user-courses/{user_id}/{course_id}` - отвязать студента от курса

5. **Редактирование студента**
   - `PATCH /api/v1/users/{id}` - частичное обновление данных студента

## Содержание

1. [Аутентификация](#аутентификация)
2. [Эндпойнты для работы со списком пользователей](#эндпойнты-для-работы-со-списком-пользователей)
3. [Эндпойнты для связи студент-преподаватель](#эндпойнты-для-связи-студент-преподаватель)
4. [Эндпойнты для связи студент-курс](#эндпойнты-для-связи-студент-курс)
5. [Эндпойнты для редактирования пользователей](#эндпойнты-для-редактирования-пользователей)
6. [Схемы данных](#схемы-данных)
7. [Коды ответов и ошибки](#коды-ответов-и-ошибки)
8. [Примеры использования](#примеры-использования)
9. [Часто задаваемые вопросы (FAQ)](#часто-задаваемые-вопросы-faq)

---

## Аутентификация

Все эндпойнты требуют API ключ в query-параметре `api_key`.

**Пример:**
```
GET /api/v1/users/?api_key=bot-key-1
```

**Доступные API ключи:** Настраиваются в переменной окружения `VALID_API_KEYS` (через запятую).

**Ошибка аутентификации:**
- **Код:** `403 Forbidden`
- **Ответ:** `{"detail": "Invalid or missing API Key"}`

---

## Эндпойнты для работы со списком пользователей

### 1. GET /api/v1/users/ - Список пользователей с пагинацией, сортировкой и фильтрацией

**Описание:** Получить список пользователей с поддержкой пагинации, сортировки и фильтрации по роли.

**URL:** `/api/v1/users/`

**Метод:** `GET`

**Параметры запроса (все опциональны):**

| Параметр | Тип | Обязательный | По умолчанию | Описание | Примеры |
|----------|-----|--------------|--------------|----------|---------|
| `skip` | `int` | Нет | `0` | Смещение для пагинации (сколько записей пропустить) | `0`, `10`, `50` |
| `limit` | `int` | Нет | `100` | Максимум результатов на странице (от 1 до 1000) | `10`, `50`, `100` |
| `sort_by` | `enum` | Нет | `full_name` | Поле для сортировки: `full_name`, `email`, `created_at` | `full_name`, `email`, `created_at` |
| `order` | `enum` | Нет | `asc` | Направление сортировки: `asc` (по возрастанию) или `desc` (по убыванию) | `asc`, `desc` |
| `role` | `string` | Нет | `null` | Фильтр по роли по имени. Если роль не найдена, возвращается пустой список | `student`, `teacher`, `Администратор` |
| `api_key` | `string` | Да | - | API ключ для аутентификации | `bot-key-1` |

**Особенности:**
- Все параметры опциональны (используются значения по умолчанию)
- Сортировка по умолчанию: `full_name ASC` (алфавитный порядок)
- NULL значения в полях сортировки всегда идут в конец списка
- Фильтрация по роли выполняется по имени роли (регистр не важен)

**Примеры запросов:**

```bash
# Получить всех пользователей (сортировка по умолчанию: full_name ASC)
GET /api/v1/users/?api_key=bot-key-1

# Получить только студентов, отсортированных по ФИО
GET /api/v1/users/?role=student&sort_by=full_name&order=asc&api_key=bot-key-1

# Получить последних зарегистрированных пользователей
GET /api/v1/users/?sort_by=created_at&order=desc&limit=10&api_key=bot-key-1

# Получить вторую страницу (по 50 записей)
GET /api/v1/users/?skip=50&limit=50&api_key=bot-key-1

# Получить всех студентов, отсортированных по email по убыванию
GET /api/v1/users/?role=student&sort_by=email&order=desc&api_key=bot-key-1
```

**Ответ (200 OK):**

```json
{
  "items": [
    {
      "id": 13,
      "email": "test_student_1@example.com",
      "full_name": "Студент Тестовый 1",
      "tg_id": null,
      "created_at": "2026-01-26T14:21:50.221Z"
    },
    {
      "id": 14,
      "email": "test_student_2@example.com",
      "full_name": "Студент Тестовый 2",
      "tg_id": null,
      "created_at": "2026-01-26T14:21:50.249Z"
    }
  ],
  "meta": {
    "total": 3,
    "limit": 50,
    "offset": 0
  }
}
```

**Структура ответа:**

- `items` (array): Массив объектов `UserRead` с информацией о пользователях
- `meta` (object): Метаданные пагинации
  - `total` (int): Общее количество записей (без учета limit/offset)
  - `limit` (int): Лимит на страницу
  - `offset` (int): Смещение

**Коды ответов:**

| Код | Описание | Причина |
|-----|----------|---------|
| `200` | Успешно | Список пользователей получен |
| `403` | Forbidden | Неверный или отсутствующий API ключ |
| `422` | Unprocessable Entity | Ошибка валидации параметров (неверный тип или значение) |

**Возможные ошибки валидации:**
- `limit` меньше 1 или больше 1000
- `skip` меньше 0
- Неверное значение `sort_by` (не из enum: full_name, email, created_at)
- Неверное значение `order` (не из enum: asc, desc)

---

### 2. GET /api/v1/users/search - Поиск пользователей по фрагменту имени

**Описание:** Поиск пользователей по фрагменту имени в поле `full_name` с опциональной фильтрацией по роли (преподаватель/студент/методист).

**URL:** `/api/v1/users/search`

**Метод:** `GET`

**Параметры запроса:**

| Параметр | Тип | Обязательный | По умолчанию | Описание | Примеры |
|----------|-----|--------------|--------------|----------|---------|
| `q` | `string` | Да | - | Фрагмент имени для поиска (минимум 2 символа) | `Иван`, `Петр`, `test` |
| `role` | `string` | Нет | - | Фильтр по роли по имени (case-insensitive): `teacher`, `student`, `methodist` | `teacher`, `student`, `methodist` |
| `limit` | `int` | Нет | `20` | Максимум результатов (от 1 до 200) | `10`, `20`, `50` |
| `offset` | `int` | Нет | `0` | Смещение для пагинации | `0`, `10`, `20` |
| `api_key` | `string` | Да | - | API ключ для аутентификации | `bot-key-1` |

**Особенности:**
- Поиск нечувствителен к регистру (case-insensitive)
- Поиск выполняется по шаблону `ILIKE %q%` (содержит подстроку)
- Фильтрация по роли выполняется по имени роли (без учета регистра)
- Результаты автоматически сортируются по `full_name` ASC
- Минимальная длина запроса: 2 символа

**Примеры запросов:**

```bash
# Поиск преподавателей с "Иван" в имени
GET /api/v1/users/search?q=Иван&role=teacher&api_key=bot-key-1

# Поиск студентов с "Иван" в имени
GET /api/v1/users/search?q=Иван&role=student&api_key=bot-key-1

# Поиск методистов с "Иван" в имени
GET /api/v1/users/search?q=Иван&role=methodist&api_key=bot-key-1

# Поиск с ограничением результатов
GET /api/v1/users/search?q=test&role=student&limit=10&api_key=bot-key-1

# Поиск с пагинацией
GET /api/v1/users/search?q=Студент&role=student&offset=10&limit=10&api_key=bot-key-1
```

**Ответ (200 OK):**

```json
[
  {
    "id": 13,
    "email": "test_student_1@example.com",
    "full_name": "Студент Тестовый 1",
    "tg_id": null,
    "created_at": "2026-01-26T14:21:50.221Z"
  },
  {
    "id": 14,
    "email": "test_student_2@example.com",
    "full_name": "Студент Тестовый 2",
    "tg_id": null,
    "created_at": "2026-01-26T14:21:50.249Z"
  }
]
```

**Коды ответов:**

| Код | Описание | Причина |
|-----|----------|---------|
| `200` | Успешно | Поиск выполнен успешно |
| `400` | Bad Request | Запрос слишком короткий (менее 2 символов) |
| `403` | Forbidden | Неверный или отсутствующий API ключ |
| `422` | Unprocessable Entity | Ошибка валидации параметров |

**Возможные ошибки:**
- `q` меньше 2 символов → `400 Bad Request`
- `limit` меньше 1 или больше 200 → `422 Unprocessable Entity`
- `offset` меньше 0 → `422 Unprocessable Entity`

---

### 3. GET /api/v1/users/by-tg/{tg_id} - Получить ID пользователя по Telegram ID

**Описание:** Найти пользователя по его Telegram ID и вернуть только его ID в системе.

**URL:** `/api/v1/users/by-tg/{tg_id}`

**Метод:** `GET`

**Параметры пути:**

| Параметр | Тип | Обязательный | Описание | Примеры |
|----------|-----|--------------|----------|---------|
| `tg_id` | `int` | Да | Telegram ID пользователя | `123456789`, `987654321` |

**Параметры запроса:**

| Параметр | Тип | Обязательный | Описание |
|----------|-----|--------------|----------|
| `api_key` | `string` | Да | API ключ для аутентификации |

**Пример запроса:**

```bash
GET /api/v1/users/by-tg/123456789?api_key=bot-key-1
```

**Ответ (200 OK):**

```json
{
  "id": 10
}
```

**Коды ответов:**

| Код | Описание | Причина |
|-----|----------|---------|
| `200` | Успешно | Пользователь найден |
| `404` | Not Found | Пользователь с указанным Telegram ID не найден |
| `403` | Forbidden | Неверный или отсутствующий API ключ |

**Пример ошибки (404):**

```json
{
  "detail": "User with tg_id=123456789 not found"
}
```

---

## Эндпойнты для связи студент-преподаватель

### 4. GET /api/v1/users/{student_id}/teachers - Список преподавателей студента

**Описание:** Получить список всех преподавателей, привязанных к указанному студенту.

**URL:** `/api/v1/users/{student_id}/teachers`

**Метод:** `GET`

**Параметры пути:**

| Параметр | Тип | Обязательный | Описание | Примеры |
|----------|-----|--------------|----------|---------|
| `student_id` | `int` | Да | ID студента | `13`, `14`, `15` |

**Параметры запроса:**

| Параметр | Тип | Обязательный | Описание |
|----------|-----|--------------|----------|
| `api_key` | `string` | Да | API ключ для аутентификации |

**Пример запроса:**

```bash
GET /api/v1/users/13/teachers?api_key=bot-key-1
```

**Ответ (200 OK):**

```json
[
  {
    "id": 16,
    "email": "test_teacher_1@example.com",
    "full_name": "Преподаватель Тестовый 1",
    "tg_id": null,
    "created_at": "2026-01-26T14:21:50.253Z"
  },
  {
    "id": 17,
    "email": "test_teacher_2@example.com",
    "full_name": "Преподаватель Тестовый 2",
    "tg_id": null,
    "created_at": "2026-01-26T14:21:50.255Z"
  }
]
```

**Коды ответов:**

| Код | Описание | Причина |
|-----|----------|---------|
| `200` | Успешно | Список получен успешно (может быть пустым) |
| `403` | Forbidden | Неверный или отсутствующий API ключ |
| `404` | Not Found | Студент не найден (если проверка выполняется на уровне сервиса) |

**Примечания:**
- Если у студента нет привязанных преподавателей, возвращается пустой массив `[]`
- Связь двусторонняя: если преподаватель привязан к студенту, студент также виден в списке студентов преподавателя

---

### 5. GET /api/v1/users/{teacher_id}/students - Список студентов преподавателя

**Описание:** Получить список всех студентов, привязанных к указанному преподавателю.

**URL:** `/api/v1/users/{teacher_id}/students`

**Метод:** `GET`

**Параметры пути:**

| Параметр | Тип | Обязательный | Описание | Примеры |
|----------|-----|--------------|----------|---------|
| `teacher_id` | `int` | Да | ID преподавателя | `16`, `17` |

**Параметры запроса:**

| Параметр | Тип | Обязательный | Описание |
|----------|-----|--------------|----------|
| `api_key` | `string` | Да | API ключ для аутентификации |

**Пример запроса:**

```bash
GET /api/v1/users/16/students?api_key=bot-key-1
```

**Ответ (200 OK):**

```json
[
  {
    "id": 13,
    "email": "test_student_1@example.com",
    "full_name": "Студент Тестовый 1",
    "tg_id": null,
    "created_at": "2026-01-26T14:21:50.221Z"
  },
  {
    "id": 14,
    "email": "test_student_2@example.com",
    "full_name": "Студент Тестовый 2",
    "tg_id": null,
    "created_at": "2026-01-26T14:21:50.249Z"
  }
]
```

**Коды ответов:**

| Код | Описание | Причина |
|-----|----------|---------|
| `200` | Успешно | Список получен успешно (может быть пустым) |
| `403` | Forbidden | Неверный или отсутствующий API ключ |
| `404` | Not Found | Преподаватель не найден (если проверка выполняется на уровне сервиса) |

**Примечания:**
- Если у преподавателя нет привязанных студентов, возвращается пустой массив `[]`
- Связь двусторонняя: если студент привязан к преподавателю, преподаватель также виден в списке преподавателей студента

---

### 6. POST /api/v1/users/{student_id}/teachers/{teacher_id} - Привязать студента к преподавателю

**Описание:** Привязать преподавателя к студенту. Связь создается в обе стороны.

**URL:** `/api/v1/users/{student_id}/teachers/{teacher_id}`

**Метод:** `POST`

**Параметры пути:**

| Параметр | Тип | Обязательный | Описание | Примеры |
|----------|-----|--------------|----------|---------|
| `student_id` | `int` | Да | ID студента | `13`, `14`, `15` |
| `teacher_id` | `int` | Да | ID преподавателя | `16`, `17` |

**Параметры запроса:**

| Параметр | Тип | Обязательный | Описание |
|----------|-----|--------------|----------|
| `api_key` | `string` | Да | API ключ для аутентификации |

**Пример запроса:**

```bash
POST /api/v1/users/13/teachers/16?api_key=bot-key-1
```

**Ответ (204 No Content):**

Тело ответа пустое.

**Коды ответов:**

| Код | Описание | Причина |
|-----|----------|---------|
| `204` | No Content | Связь успешно создана (или уже существовала) |
| `404` | Not Found | Студент или преподаватель не найден |
| `403` | Forbidden | Неверный или отсутствующий API ключ |

**Пример ошибки (404):**

```json
{
  "detail": "User or Role not found"
}
```

**Примечания:**
- Операция идемпотентна: повторный вызов с теми же параметрами не вызовет ошибку
- После создания связи студент появится в списке студентов преподавателя (GET /users/{teacher_id}/students)
- Преподаватель появится в списке преподавателей студента (GET /users/{student_id}/teachers)

---

### 7. DELETE /api/v1/users/{student_id}/teachers/{teacher_id} - Отвязать студента от преподавателя

**Описание:** Удалить связь между студентом и преподавателем. Связь удаляется в обе стороны.

**URL:** `/api/v1/users/{student_id}/teachers/{teacher_id}`

**Метод:** `DELETE`

**Параметры пути:**

| Параметр | Тип | Обязательный | Описание | Примеры |
|----------|-----|--------------|----------|---------|
| `student_id` | `int` | Да | ID студента | `13`, `14`, `15` |
| `teacher_id` | `int` | Да | ID преподавателя | `16`, `17` |

**Параметры запроса:**

| Параметр | Тип | Обязательный | Описание |
|----------|-----|--------------|----------|
| `api_key` | `string` | Да | API ключ для аутентификации |

**Пример запроса:**

```bash
DELETE /api/v1/users/13/teachers/16?api_key=bot-key-1
```

**Ответ (204 No Content):**

Тело ответа пустое.

**Коды ответов:**

| Код | Описание | Причина |
|-----|----------|---------|
| `204` | No Content | Связь успешно удалена (или не существовала) |
| `403` | Forbidden | Неверный или отсутствующий API ключ |

**Примечания:**
- Операция идемпотентна: если связи не было, ошибки не будет
- После удаления связи студент исчезнет из списка студентов преподавателя
- Преподаватель исчезнет из списка преподавателей студента

---

## Эндпойнты для связи студент-курс

### 8. GET /api/v1/users/{user_id}/courses - Получить список курсов пользователя

**Описание:** Получить список курсов пользователя с информацией о курсах. Поддерживает пользователей с несколькими ролями одновременно (преподаватель и студент). Для студентов возвращает курсы из таблицы `user_courses`.

**URL:** `/api/v1/users/{user_id}/courses`

**Метод:** `GET`

**Параметры пути:**

| Параметр | Тип | Обязательный | Описание | Примеры |
|----------|-----|--------------|----------|---------|
| `user_id` | `int` | Да | ID пользователя (студента) | `13`, `14`, `15` |

**Параметры запроса:**

| Параметр | Тип | Обязательный | По умолчанию | Описание | Примеры |
|----------|-----|--------------|--------------|----------|---------|
| `role` | `string` | Нет | - | Фильтр по роли: `teacher` - только курсы преподавателя, `student` - только курсы студента. Если не указан - возвращаются курсы из обеих таблиц | `teacher`, `student` |
| `order_by_order` | `bool` | Нет | `true` | Сортировать по order_number (True) или по added_at (False) | `true`, `false` |
| `api_key` | `string` | Да | - | API ключ для аутентификации | `bot-key-1` |

**Особенности:**
- Пользователь может быть одновременно и преподавателем, и студентом
- Если параметр `role` не указан - возвращаются курсы из обеих таблиц (`teacher_courses` и `user_courses`) в объединенном списке
- Если параметр `role=student` - возвращаются только курсы студента из таблицы `user_courses`
- Если параметр `role=teacher` - возвращаются только курсы преподавателя из таблицы `teacher_courses`
- Для студентов поле `order_number` может быть задано (порядковый номер курса у студента)
- Для преподавателей поле `order_number` всегда `null` (у преподавателей нет порядкового номера)
- При `order_by_order=true` для студентов сортировка выполняется сначала по `order_number`, затем по `added_at`
- При `order_by_order=false` для студентов сортировка выполняется только по `added_at`
- При объединении списков (когда `role` не указан) сортировка выполняется по дате (`added_at` для студентов, `linked_at` для преподавателей)

**Примеры запросов:**

```bash
# Получить все курсы студента (только из user_courses, если студент не является преподавателем)
GET /api/v1/users/13/courses?api_key=bot-key-1

# Получить только курсы студента (явно указать роль)
GET /api/v1/users/13/courses?role=student&api_key=bot-key-1

# Получить курсы студента, отсортированные по порядковому номеру
GET /api/v1/users/13/courses?role=student&order_by_order=true&api_key=bot-key-1

# Получить курсы студента, отсортированные по дате добавления (старые сначала)
GET /api/v1/users/13/courses?role=student&order_by_order=false&api_key=bot-key-1

# Получить все курсы пользователя (и как студента, и как преподавателя, если есть обе роли)
GET /api/v1/users/2/courses?api_key=bot-key-1
```

**Ответ (200 OK):**

```json
{
  "user_id": 13,
  "courses": [
    {
      "user_id": 13,
      "course_id": 1,
      "added_at": "2026-01-26T15:00:00Z",
      "order_number": 1,
      "course": {
        "id": 1,
        "title": "Основы Python",
        "access_level": "auto_check",
        "description": "Введение в Python",
        "parent_course_ids": [],
        "created_at": "2026-01-20T10:00:00Z",
        "is_required": false,
        "course_uid": "COURSE-PY-01"
      }
    },
    {
      "user_id": 13,
      "course_id": 2,
      "added_at": "2026-01-26T15:05:00Z",
      "order_number": 2,
      "course": {
        "id": 2,
        "title": "Продвинутый Python",
        "access_level": "auto_check",
        "description": "Продвинутые темы Python",
        "parent_course_ids": [1],
        "created_at": "2026-01-20T10:00:00Z",
        "is_required": false,
        "course_uid": "COURSE-PY-02"
      }
    }
  ]
}
```

**Структура ответа:**

- `user_id` (int): ID пользователя
- `courses` (array): Массив объектов `UserCourseWithCourse` с информацией о курсах
  - `user_id` (int): ID пользователя
  - `course_id` (int): ID курса
  - `added_at` (datetime): Дата и время привязки студента к курсу (ISO 8601)
  - `order_number` (int | null): Порядковый номер курса у студента (может быть `null`, если не задан)
  - `course` (object): Полная информация о курсе (объект `CourseRead`)
    - `id` (int): ID курса
    - `title` (string): Название курса
    - `access_level` (string): Уровень доступа к курсу
    - `description` (string | null): Описание курса
    - `parent_course_ids` (array[int]): Массив ID родительских курсов
    - `created_at` (datetime): Дата создания курса
    - `is_required` (bool): Обязательный ли курс
    - `course_uid` (string): Уникальный идентификатор курса

**Коды ответов:**

| Код | Описание | Причина |
|-----|----------|---------|
| `200` | Успешно | Список курсов успешно получен |
| `400` | Bad Request | Некорректное значение параметра `role` (должно быть `teacher` или `student`) |
| `404` | Not Found | Пользователь с указанным ID не найден |
| `403` | Forbidden | Неверный или отсутствующий API ключ |

**Пример ошибки (400):**

```json
{
  "detail": "Некорректное значение параметра role: 'invalid'. Допустимые значения: 'teacher', 'student'"
}
```

**Пример ошибки (404):**

```json
{
  "detail": "Пользователь с ID 999 не найден"
}
```

**Примечания:**
- Если у студента нет привязанных курсов, возвращается пустой массив `courses: []`
- Параметр `role` поддерживает как английские (`teacher`, `student`), так и русские (`преподаватель`, `студент`) названия ролей
- Если студент также является преподавателем и параметр `role` не указан, возвращаются курсы из обеих таблиц
- Поле `order_number` устанавливается автоматически триггером БД при добавлении курса, если не указано явно
- При сортировке по `order_number` записи с `null` идут в конец списка

---

### 9. POST /api/v1/user-courses/ - Привязать студента к курсу

**Описание:** Привязать студента к курсу. Используется для добавления студента к курсу как из меню курсов, так и из меню студентов.

**URL:** `/api/v1/user-courses/`

**Метод:** `POST`

**Параметры запроса:**

| Параметр | Тип | Обязательный | Описание |
|----------|-----|--------------|----------|
| `api_key` | `string` | Да | API ключ для аутентификации |

**Тело запроса (JSON):**

| Поле | Тип | Обязательное | Описание | Примеры |
|------|-----|--------------|----------|---------|
| `user_id` | `int` | Да | ID пользователя (студента) | `13`, `14`, `15` |
| `course_id` | `int` | Да | ID курса | `1`, `2`, `3` |
| `order_number` | `int` | Нет | Порядковый номер курса у пользователя. Если не указан, проставится автоматически триггером БД | `1`, `2`, `null` |

**Пример запроса:**

```bash
POST /api/v1/user-courses/?api_key=bot-key-1
Content-Type: application/json

{
  "user_id": 13,
  "course_id": 1,
  "order_number": null
}
```

**Ответ (201 Created):**

```json
{
  "user_id": 13,
  "course_id": 1,
  "added_at": "2026-01-26T15:00:00Z",
  "order_number": 1
}
```

**Коды ответов:**

| Код | Описание | Причина |
|-----|----------|---------|
| `201` | Created | Связь успешно создана |
| `400` | Bad Request | Дубликат связи (студент уже привязан к курсу) или некорректные данные |
| `403` | Forbidden | Неверный или отсутствующий API ключ |
| `422` | Unprocessable Entity | Ошибка валидации данных запроса |

**Пример ошибки (400):**

```json
{
  "detail": "Duplicate entry or invalid data"
}
```

**Примечания:**
- Пара (user_id, course_id) должна быть уникальной (составной PK)
- При попытке создать дубликат связи возвращается ошибка 400
- Если `order_number` не указан (null), он проставится автоматически триггером БД

---

### 9. DELETE /api/v1/user-courses/{user_id}/{course_id} - Отвязать студента от курса

**Описание:** Отвязать студента от курса. Используется для удаления студента из курса как из меню курсов, так и из меню студентов.

**URL:** `/api/v1/user-courses/{user_id}/{course_id}`

**Метод:** `DELETE`

**Параметры пути:**

| Параметр | Тип | Обязательный | Описание | Примеры |
|----------|-----|--------------|----------|---------|
| `user_id` | `int` | Да | ID пользователя (студента) | `13`, `14`, `15` |
| `course_id` | `int` | Да | ID курса | `1`, `2`, `3` |

**Параметры запроса:**

| Параметр | Тип | Обязательный | Описание |
|----------|-----|--------------|----------|
| `api_key` | `string` | Да | API ключ для аутентификации |

**Пример запроса:**

```bash
DELETE /api/v1/user-courses/13/1?api_key=bot-key-1
```

**Ответ (204 No Content):**

Тело ответа пустое.

**Коды ответов:**

| Код | Описание | Причина |
|-----|----------|---------|
| `204` | No Content | Связь успешно удалена |
| `404` | Not Found | Связь не найдена (студент не привязан к курсу) |
| `403` | Forbidden | Неверный или отсутствующий API ключ |

**Пример ошибки (404):**

```json
{
  "detail": "Not found"
}
```

**Примечания:**
- Операция идемпотентна: если связи не было, возвращается 404
- После удаления студент больше не будет видеть курс в своем списке

---

## Эндпойнты для редактирования пользователей

### 11. GET /api/v1/users/{id} - Получить информацию о пользователе

**Описание:** Получить полную информацию о пользователе по его ID.

**URL:** `/api/v1/users/{id}`

**Метод:** `GET`

**Параметры пути:**

| Параметр | Тип | Обязательный | Описание | Примеры |
|----------|-----|--------------|----------|---------|
| `id` | `int` | Да | ID пользователя | `13`, `14`, `15` |

**Параметры запроса:**

| Параметр | Тип | Обязательный | Описание |
|----------|-----|--------------|----------|
| `api_key` | `string` | Да | API ключ для аутентификации |

**Пример запроса:**

```bash
GET /api/v1/users/13?api_key=bot-key-1
```

**Ответ (200 OK):**

```json
{
  "id": 13,
  "email": "test_student_1@example.com",
  "full_name": "Студент Тестовый 1",
  "tg_id": null,
  "created_at": "2026-01-26T14:21:50.221Z"
}
```

**Коды ответов:**

| Код | Описание | Причина |
|-----|----------|---------|
| `200` | OK | Пользователь найден |
| `404` | Not Found | Пользователь с указанным ID не найден |
| `403` | Forbidden | Неверный или отсутствующий API ключ |

---

### 12. POST /api/v1/users/ - Создать нового пользователя

**Описание:** Создать нового пользователя в системе.

**URL:** `/api/v1/users/`

**Метод:** `POST`

**Параметры запроса:**

| Параметр | Тип | Обязательный | Описание |
|----------|-----|--------------|----------|
| `api_key` | `string` | Да | API ключ для аутентификации |

**Тело запроса (JSON):**

| Поле | Тип | Обязательное | Описание | Примеры |
|------|-----|--------------|----------|---------|
| `email` | `string` | Да | Email пользователя (уникальный, валидный email) | `student@example.com` |
| `full_name` | `string` | Нет | Полное имя пользователя | `Иван Иванов` |
| `tg_id` | `int` | Нет | Telegram ID пользователя | `123456789` |

**Пример запроса:**

```bash
POST /api/v1/users/?api_key=bot-key-1
Content-Type: application/json

{
  "email": "new_student@example.com",
  "full_name": "Новый Студент",
  "tg_id": null
}
```

**Ответ (201 Created):**

```json
{
  "id": 18,
  "email": "new_student@example.com",
  "full_name": "Новый Студент",
  "tg_id": null,
  "created_at": "2026-01-26T16:00:00Z"
}
```

**Коды ответов:**

| Код | Описание | Причина |
|-----|----------|---------|
| `201` | Created | Пользователь успешно создан |
| `400` | Bad Request | Email уже существует или некорректные данные |
| `403` | Forbidden | Неверный или отсутствующий API ключ |
| `422` | Unprocessable Entity | Ошибка валидации данных (неверный формат email и т.д.) |

**Примечания:**
- Email должен быть уникальным в системе
- Email должен быть валидным (формат проверяется автоматически)
- Пароль генерируется автоматически (не передается в запросе)

---

### 13. PUT /api/v1/users/{id} - Полное обновление пользователя

**Описание:** Полностью обновить данные пользователя. Все поля обязательны.

**URL:** `/api/v1/users/{id}`

**Метод:** `PUT`

**Параметры пути:**

| Параметр | Тип | Обязательный | Описание | Примеры |
|----------|-----|--------------|----------|---------|
| `id` | `int` | Да | ID пользователя | `13`, `14`, `15` |

**Параметры запроса:**

| Параметр | Тип | Обязательный | Описание |
|----------|-----|--------------|----------|
| `api_key` | `string` | Да | API ключ для аутентификации |

**Тело запроса (JSON):**

| Поле | Тип | Обязательное | Описание | Примеры |
|------|-----|--------------|----------|---------|
| `email` | `string` | Да | Email пользователя (валидный email) | `newemail@example.com` |
| `full_name` | `string` | Нет | Полное имя пользователя | `Новое Имя` |
| `tg_id` | `int` | Нет | Telegram ID пользователя | `987654321` |

**Пример запроса:**

```bash
PUT /api/v1/users/13?api_key=bot-key-1
Content-Type: application/json

{
  "email": "updated@example.com",
  "full_name": "Обновленное Имя",
  "tg_id": 987654321
}
```

**Ответ (200 OK):**

```json
{
  "id": 13,
  "email": "updated@example.com",
  "full_name": "Обновленное Имя",
  "tg_id": 987654321,
  "created_at": "2026-01-26T14:21:50.221Z"
}
```

**Коды ответов:**

| Код | Описание | Причина |
|-----|----------|---------|
| `200` | OK | Пользователь успешно обновлен |
| `404` | Not Found | Пользователь с указанным ID не найден |
| `403` | Forbidden | Неверный или отсутствующий API ключ |
| `422` | Unprocessable Entity | Ошибка валидации данных |

**Примечания:**
- Все поля обязательны (в отличие от PATCH)
- Email должен быть уникальным в системе
- Email должен быть валидным

---

### 14. PATCH /api/v1/users/{id} - Частичное обновление пользователя

**Описание:** Частично обновить данные пользователя. Можно обновить одно или несколько полей.

**URL:** `/api/v1/users/{id}`

**Метод:** `PATCH`

**Параметры пути:**

| Параметр | Тип | Обязательный | Описание | Примеры |
|----------|-----|--------------|----------|---------|
| `id` | `int` | Да | ID пользователя | `13`, `14`, `15` |

**Параметры запроса:**

| Параметр | Тип | Обязательный | Описание |
|----------|-----|--------------|----------|
| `api_key` | `string` | Да | API ключ для аутентификации |

**Тело запроса (JSON):**

Все поля опциональны. Обновляются только переданные поля.

| Поле | Тип | Обязательное | Описание | Примеры |
|------|-----|--------------|----------|---------|
| `email` | `string` | Нет | Email пользователя (должен быть валидным email) | `newemail@example.com` |
| `full_name` | `string` | Нет | Полное имя пользователя | `Новое Имя` |
| `tg_id` | `int` | Нет | Telegram ID пользователя | `987654321` |

**Примеры запросов:**

```bash
# Обновить только имя
PATCH /api/v1/users/13?api_key=bot-key-1
Content-Type: application/json

{
  "full_name": "Новое Имя"
}

# Обновить email и имя
PATCH /api/v1/users/13?api_key=bot-key-1
Content-Type: application/json

{
  "email": "newemail@example.com",
  "full_name": "Обновленное Имя"
}

# Обновить только Telegram ID
PATCH /api/v1/users/13?api_key=bot-key-1
Content-Type: application/json

{
  "tg_id": 987654321
}
```

**Ответ (200 OK):**

```json
{
  "id": 13,
  "email": "newemail@example.com",
  "full_name": "Обновленное Имя",
  "tg_id": 987654321,
  "created_at": "2026-01-26T14:21:50.221Z"
}
```

**Коды ответов:**

| Код | Описание | Причина |
|-----|----------|---------|
| `200` | OK | Пользователь успешно обновлен |
| `404` | Not Found | Пользователь с указанным ID не найден |
| `403` | Forbidden | Неверный или отсутствующий API ключ |
| `422` | Unprocessable Entity | Ошибка валидации данных (неверный формат email и т.д.) |

**Пример ошибки (404):**

```json
{
  "detail": "Not found"
}
```

**Пример ошибки (422):**

```json
{
  "detail": [
    {
      "loc": ["body", "email"],
      "msg": "value is not a valid email address",
      "type": "value_error.email"
    }
  ]
}
```

**Примечания:**
- Обновляются только переданные поля (частичное обновление)
- Поля, которые не переданы, остаются без изменений
- Email должен быть уникальным в системе
- Email должен быть валидным (формат проверяется автоматически)

**Разница между PUT и PATCH:**
- **PUT** - полное обновление (все поля обязательны)
- **PATCH** - частичное обновление (все поля опциональны)

---

### 15. DELETE /api/v1/users/{id} - Удалить пользователя

**Описание:** Удалить пользователя из системы.

**URL:** `/api/v1/users/{id}`

**Метод:** `DELETE`

**Параметры пути:**

| Параметр | Тип | Обязательный | Описание | Примеры |
|----------|-----|--------------|----------|---------|
| `id` | `int` | Да | ID пользователя | `13`, `14`, `15` |

**Параметры запроса:**

| Параметр | Тип | Обязательный | Описание |
|----------|-----|--------------|----------|
| `api_key` | `string` | Да | API ключ для аутентификации |

**Пример запроса:**

```bash
DELETE /api/v1/users/13?api_key=bot-key-1
```

**Ответ (204 No Content):**

Тело ответа пустое.

**Коды ответов:**

| Код | Описание | Причина |
|-----|----------|---------|
| `204` | No Content | Пользователь успешно удален |
| `404` | Not Found | Пользователь с указанным ID не найден |
| `403` | Forbidden | Неверный или отсутствующий API ключ |

**Примечания:**
- При удалении пользователя автоматически удаляются все связанные записи (связи с курсами, преподавателями и т.д.) благодаря CASCADE в БД
- Операция необратима

---

## Схемы данных

### UserRead

Схема для чтения информации о пользователе.

```json
{
  "id": 13,
  "email": "test_student_1@example.com",
  "full_name": "Студент Тестовый 1",
  "tg_id": null,
  "created_at": "2026-01-26T14:21:50.221Z"
}
```

**Поля:**

| Поле | Тип | Описание | Примеры |
|------|-----|----------|---------|
| `id` | `int` | ID пользователя в системе | `13`, `16` |
| `email` | `string` | Email пользователя (уникальный) | `student@example.com` |
| `full_name` | `string \| null` | Полное имя пользователя | `Иван Иванов`, `null` |
| `tg_id` | `int \| null` | Telegram ID пользователя | `123456789`, `null` |
| `created_at` | `datetime` | Дата и время регистрации пользователя (ISO 8601) | `2026-01-26T14:21:50.221Z` |

---

### UserCreate

Схема для создания пользователя.

```json
{
  "email": "student@example.com",
  "full_name": "Иван Иванов",
  "tg_id": null
}
```

**Поля:**

| Поле | Тип | Обязательное | Описание | Примеры |
|------|-----|--------------|----------|---------|
| `email` | `string` | Да | Email пользователя (уникальный, валидный email) | `student@example.com` |
| `full_name` | `string` | Нет | Полное имя пользователя | `Иван Иванов` |
| `tg_id` | `int` | Нет | Telegram ID пользователя | `123456789` |

---

### UserUpdate

Схема для обновления пользователя (частичное обновление - все поля опциональны).

```json
{
  "email": "newemail@example.com",
  "full_name": "Новое Имя",
  "tg_id": 987654321
}
```

**Поля:**

| Поле | Тип | Обязательное | Описание | Примеры |
|------|-----|--------------|----------|---------|
| `email` | `string` | Нет | Email пользователя (валидный email) | `newemail@example.com` |
| `full_name` | `string` | Нет | Полное имя пользователя | `Новое Имя` |
| `tg_id` | `int` | Нет | Telegram ID пользователя | `987654321` |

**Примечания:**
- Все поля опциональны
- Обновляются только переданные поля
- Email должен быть уникальным в системе (если обновляется)

---

### Page[UserRead]

Схема для пагинированного списка пользователей.

```json
{
  "items": [
    {
      "id": 13,
      "email": "test_student_1@example.com",
      "full_name": "Студент Тестовый 1",
      "tg_id": null,
      "created_at": "2026-01-26T14:21:50.221Z"
    }
  ],
  "meta": {
    "total": 3,
    "limit": 50,
    "offset": 0
  }
}
```

**Поля:**

| Поле | Тип | Описание |
|------|-----|----------|
| `items` | `array[UserRead]` | Массив пользователей текущей страницы |
| `meta` | `object` | Метаданные пагинации |
| `meta.total` | `int` | Общее количество записей (без учета limit/offset) |
| `meta.limit` | `int` | Лимит на страницу |
| `meta.offset` | `int` | Смещение |

---

### UserCourseRead

Схема для чтения связи пользователя и курса.

```json
{
  "user_id": 13,
  "course_id": 1,
  "added_at": "2026-01-26T15:00:00Z",
  "order_number": 1
}
```

**Поля:**

| Поле | Тип | Описание | Примеры |
|------|-----|----------|---------|
| `user_id` | `int` | ID пользователя (студента) | `13` |
| `course_id` | `int` | ID курса | `1` |
| `added_at` | `datetime` | Дата и время привязки (ISO 8601) | `2026-01-26T15:00:00Z` |
| `order_number` | `int \| null` | Порядковый номер курса у пользователя | `1`, `null` |

---

### UserCourseCreate

Схема для создания связи пользователя и курса.

```json
{
  "user_id": 13,
  "course_id": 1,
  "order_number": null
}
```

**Поля:**

| Поле | Тип | Обязательное | Описание | Примеры |
|------|-----|--------------|----------|---------|
| `user_id` | `int` | Да | ID пользователя (студента) | `13` |
| `course_id` | `int` | Да | ID курса | `1` |
| `order_number` | `int` | Нет | Порядковый номер курса у пользователя. Если не указан, проставится автоматически триггером БД | `1`, `null` |

---

## Коды ответов и ошибки

### Успешные ответы

| Код | Описание | Когда используется |
|-----|----------|-------------------|
| `200` | OK | Успешный GET, PUT, PATCH запрос |
| `201` | Created | Успешное создание ресурса (POST) |
| `204` | No Content | Успешное удаление или операция без тела ответа (DELETE, POST для связей) |

### Ошибки клиента (4xx)

| Код | Описание | Причины | Пример ответа |
|-----|----------|---------|----------------|
| `400` | Bad Request | Некорректный запрос, дубликат связи | `{"detail": "Duplicate entry or invalid data"}` |
| `403` | Forbidden | Неверный или отсутствующий API ключ | `{"detail": "Invalid or missing API Key"}` |
| `404` | Not Found | Ресурс не найден (пользователь, связь и т.д.) | `{"detail": "Not found"}` или `{"detail": "User with tg_id=123 not found"}` |
| `422` | Unprocessable Entity | Ошибка валидации параметров или данных запроса | `{"detail": [{"loc": ["body", "email"], "msg": "value is not a valid email address", "type": "value_error.email"}]}` |

### Ошибки сервера (5xx)

| Код | Описание | Причины |
|-----|----------|---------|
| `500` | Internal Server Error | Внутренняя ошибка сервера |

---

## Примеры использования

### Пример 1: Получить список всех студентов, отсортированных по ФИО

```bash
GET /api/v1/users/?role=student&sort_by=full_name&order=asc&api_key=bot-key-1
```

**Ответ:**
```json
{
  "items": [
    {
      "id": 13,
      "email": "test_student_1@example.com",
      "full_name": "Студент Тестовый 1",
      "tg_id": null,
      "created_at": "2026-01-26T14:21:50.221Z"
    },
    {
      "id": 14,
      "email": "test_student_2@example.com",
      "full_name": "Студент Тестовый 2",
      "tg_id": null,
      "created_at": "2026-01-26T14:21:50.249Z"
    },
    {
      "id": 15,
      "email": "test_student_3@example.com",
      "full_name": "Студент Тестовый 3",
      "tg_id": null,
      "created_at": "2026-01-26T14:21:50.251Z"
    }
  ],
  "meta": {
    "total": 3,
    "limit": 100,
    "offset": 0
  }
}
```

---

### Пример 2: Привязать студента к преподавателю

```bash
POST /api/v1/users/13/teachers/16?api_key=bot-key-1
```

**Ответ:** `204 No Content` (тело пустое)

**Проверка:**
```bash
GET /api/v1/users/13/teachers?api_key=bot-key-1
```

**Ответ:**
```json
[
  {
    "id": 16,
    "email": "test_teacher_1@example.com",
    "full_name": "Преподаватель Тестовый 1",
    "tg_id": null,
    "created_at": "2026-01-26T14:21:50.253Z"
  }
]
```

---

### Пример 3: Получить список курсов студента

```bash
# Получить все курсы студента
GET /api/v1/users/13/courses?api_key=bot-key-1
```

**Ответ:**
```json
{
  "user_id": 13,
  "courses": [
    {
      "user_id": 13,
      "course_id": 1,
      "added_at": "2026-01-26T15:00:00Z",
      "order_number": 1,
      "course": {
        "id": 1,
        "title": "Основы Python",
        "access_level": "auto_check",
        "description": "Введение в Python",
        "parent_course_ids": [],
        "created_at": "2026-01-20T10:00:00Z",
        "is_required": false,
        "course_uid": "COURSE-PY-01"
      }
    }
  ]
}
```

---

### Пример 4: Привязать студента к курсу

```bash
POST /api/v1/user-courses/?api_key=bot-key-1
Content-Type: application/json

{
  "user_id": 13,
  "course_id": 1,
  "order_number": null
}
```

**Ответ:**
```json
{
  "user_id": 13,
  "course_id": 1,
  "added_at": "2026-01-26T15:00:00Z",
  "order_number": 1
}
```

---

### Пример 5: Обновить имя студента

```bash
PATCH /api/v1/users/13?api_key=bot-key-1
Content-Type: application/json

{
  "full_name": "Обновленное Имя Студента"
}
```

**Ответ:**
```json
{
  "id": 13,
  "email": "test_student_1@example.com",
  "full_name": "Обновленное Имя Студента",
  "tg_id": null,
  "created_at": "2026-01-26T14:21:50.221Z"
}
```

---

### Пример 6: Поиск студентов по имени

```bash
GET /api/v1/users/search?q=Студент&limit=10&api_key=bot-key-1
```

**Ответ:**
```json
[
  {
    "id": 13,
    "email": "test_student_1@example.com",
    "full_name": "Студент Тестовый 1",
    "tg_id": null,
    "created_at": "2026-01-26T14:21:50.221Z"
  },
  {
    "id": 14,
    "email": "test_student_2@example.com",
    "full_name": "Студент Тестовый 2",
    "tg_id": null,
    "created_at": "2026-01-26T14:21:50.249Z"
  },
  {
    "id": 15,
    "email": "test_student_3@example.com",
    "full_name": "Студент Тестовый 3",
    "tg_id": null,
    "created_at": "2026-01-26T14:21:50.251Z"
  }
]
```

---

## Часто задаваемые вопросы (FAQ)

### 1. Как получить список только студентов?

Используйте параметр `role=student`:
```bash
GET /api/v1/users/?role=student&api_key=bot-key-1
```

### 2. Как отсортировать студентов по алфавиту ФИО?

Используйте параметры `sort_by=full_name&order=asc` (это значения по умолчанию):
```bash
GET /api/v1/users/?role=student&sort_by=full_name&order=asc&api_key=bot-key-1
```

### 3. Что делать, если роль не найдена?

Если указана несуществующая роль, API вернет пустой список `[]` без ошибки. Это нормальное поведение.

### 4. Как работает пагинация?

Используйте параметры `skip` и `limit`:
- `skip` - сколько записей пропустить (смещение)
- `limit` - сколько записей вернуть (максимум)

Пример: получить вторую страницу (по 50 записей):
```bash
GET /api/v1/users/?skip=50&limit=50&api_key=bot-key-1
```

### 5. Можно ли использовать несколько параметров одновременно?

Да, все параметры можно комбинировать:
```bash
GET /api/v1/users/?role=student&sort_by=created_at&order=desc&skip=0&limit=10&api_key=bot-key-1
```

### 6. Что происходит с NULL значениями при сортировке?

NULL значения всегда идут в конец списка (NULLS LAST), независимо от направления сортировки.

### 7. Как проверить, привязан ли студент к курсу?

Используйте GET запрос:
```bash
GET /api/v1/user-courses/{user_id}/{course_id}?api_key=bot-key-1
```

Если связь существует, вернется `200 OK` с данными связи. Если нет - `404 Not Found`.

### 9. Можно ли привязать одного студента к нескольким преподавателям?

Да, студент может быть привязан к нескольким преподавателям одновременно.

### 10. Что происходит при попытке создать дубликат связи?

- Для связи студент-преподаватель: операция идемпотентна, ошибки не будет
- Для связи студент-курс: вернется ошибка `400 Bad Request`

---

## Дополнительная информация

### Роли в системе

Доступные роли (для фильтрации по параметру `role`):
- `student` - Студент
- `teacher` - Преподаватель
- `Администратор` - Администратор
- `Методист` - Методист
- `Преподаватель` - Преподаватель (альтернативное название)
- `Студент` - Студент (альтернативное название)
- `Заказчик` - Заказчик
- `Маркетолог` - Маркетолог

**Примечание:** Роли `student` и `teacher` добавлены специально для новой функциональности. Роли `Студент` и `Преподаватель` - это существующие роли в системе.

### Сортировка по умолчанию

По умолчанию используется:
- `sort_by=full_name` (сортировка по ФИО)
- `order=asc` (по возрастанию)

Это соответствует требованию "сортировка по алфавиту ФИО".

### Обратная совместимость

Все новые параметры опциональны. Эндпойнты остаются совместимыми со старыми клиентами:
- `GET /api/v1/users/` работает без параметров (используются значения по умолчанию)
- Параметры `skip` и `limit` работают как раньше

---

## Swagger UI

Полная интерактивная документация доступна через Swagger UI:

```
http://localhost:8000/docs
```

В Swagger UI вы можете:
- Просмотреть все эндпойнты с подробными описаниями
- Увидеть схемы данных с примерами
- Протестировать эндпойнты прямо в браузере
- Увидеть все возможные коды ответов
- Увидеть примеры запросов и ответов для каждого эндпойнта

**Все описания из этой документации также доступны в Swagger UI** - они автоматически генерируются из docstrings и параметров эндпойнтов.

### Альтернативная документация (ReDoc)

Также доступна документация в формате ReDoc:

```
http://localhost:8000/redoc
```

---

## Сводная таблица всех эндпойнтов

| Метод | URL | Описание | Основное использование |
|-------|-----|----------|----------------------|
| `GET` | `/api/v1/users/` | Список пользователей с сортировкой и фильтрацией | Получить список студентов |
| `GET` | `/api/v1/users/search` | Поиск пользователей по имени | Поиск студентов |
| `GET` | `/api/v1/users/{id}` | Информация о пользователе | Получить данные студента |
| `GET` | `/api/v1/users/by-tg/{tg_id}` | ID пользователя по Telegram ID | Работа с ботом |
| `POST` | `/api/v1/users/` | Создать пользователя | Создание нового студента |
| `PUT` | `/api/v1/users/{id}` | Полное обновление пользователя | Обновление всех полей |
| `PATCH` | `/api/v1/users/{id}` | Частичное обновление пользователя | Редактирование студента |
| `DELETE` | `/api/v1/users/{id}` | Удалить пользователя | Удаление студента |
| `GET` | `/api/v1/users/{student_id}/teachers` | Список преподавателей студента | Просмотр преподавателей |
| `GET` | `/api/v1/users/{teacher_id}/students` | Список студентов преподавателя | Просмотр студентов |
| `POST` | `/api/v1/users/{student_id}/teachers/{teacher_id}` | Привязать преподавателя | Назначение преподавателя |
| `DELETE` | `/api/v1/users/{student_id}/teachers/{teacher_id}` | Отвязать преподавателя | Снятие преподавателя |
| `GET` | `/api/v1/users/{user_id}/courses` | Список курсов пользователя | Получить курсы студента |
| `POST` | `/api/v1/user-courses/` | Привязать студента к курсу | Добавление к курсу |
| `DELETE` | `/api/v1/user-courses/{user_id}/{course_id}` | Отвязать студента от курса | Удаление из курса |

---

## Важные замечания для фронтенда

### 1. Пагинация

Все списки поддерживают пагинацию через параметры `skip` и `limit`:
- `skip` - смещение (сколько записей пропустить)
- `limit` - лимит (сколько записей вернуть)

**Пример расчета страниц:**
- Страница 1: `skip=0, limit=50` (записи 0-49)
- Страница 2: `skip=50, limit=50` (записи 50-99)
- Страница 3: `skip=100, limit=50` (записи 100-149)

**Метаданные пагинации:**
```json
{
  "meta": {
    "total": 150,    // Всего записей
    "limit": 50,     // Запрошено на страницу
    "offset": 0      // Смещение (равно skip)
  }
}
```

**Расчет общего количества страниц:**
```javascript
const totalPages = Math.ceil(meta.total / meta.limit);
```

### 2. Сортировка

**Доступные поля для сортировки:**
- `full_name` - ФИО (по умолчанию)
- `email` - Email
- `created_at` - Дата регистрации

**Направления сортировки:**
- `asc` - по возрастанию (по умолчанию)
- `desc` - по убыванию

**NULL значения:**
- NULL значения всегда идут в конец списка (NULLS LAST)
- Это работает для всех полей сортировки

### 3. Фильтрация по роли

**Использование:**
```bash
GET /api/v1/users/?role=student&api_key=bot-key-1
```

**Важно:**
- Фильтрация выполняется по **имени роли** (не по ID)
- Регистр не важен (`student` = `Student` = `STUDENT`)
- Если роль не найдена, возвращается пустой список (не ошибка)

**Доступные роли:**
- `student` - Студент (новая роль)
- `teacher` - Преподаватель (новая роль)
- `Администратор` - Администратор
- `Методист` - Методист
- `Преподаватель` - Преподаватель (альтернативное название)
- `Студент` - Студент (альтернативное название)
- `Заказчик` - Заказчик
- `Маркетолог` - Маркетолог

### 4. Обработка ошибок

**Рекомендуемый подход:**
```javascript
try {
  const response = await fetch('/api/v1/users/?api_key=bot-key-1');
  if (!response.ok) {
    if (response.status === 403) {
      // Ошибка аутентификации
    } else if (response.status === 404) {
      // Ресурс не найден
    } else if (response.status === 422) {
      // Ошибка валидации
      const error = await response.json();
      // Обработать ошибки валидации
    }
  }
  const data = await response.json();
} catch (error) {
  // Обработать сетевую ошибку
}
```

### 5. Идемпотентность операций

**Идемпотентные операции (безопасно повторять):**
- `POST /api/v1/users/{student_id}/teachers/{teacher_id}` - повторный вызов не вызовет ошибку
- `DELETE /api/v1/users/{student_id}/teachers/{teacher_id}` - если связи не было, ошибки не будет

**Не идемпотентные операции:**
- `POST /api/v1/user-courses/` - повторный вызов вернет ошибку 400 (дубликат)

### 6. Валидация данных

**Email:**
- Должен быть валидным email форматом
- Должен быть уникальным в системе
- Проверка выполняется автоматически

**ID пользователей:**
- Должны быть положительными целыми числами
- Должны существовать в системе

**Параметры пагинации:**
- `skip` >= 0
- `limit` >= 1 и <= 1000 (для GET /users/)
- `limit` >= 1 и <= 200 (для GET /users/search)

---

**Дата создания документации:** 26 января 2026  
**Последнее обновление:** 27 января 2026  
**Версия API:** v1  
**Автор:** AI Assistant
