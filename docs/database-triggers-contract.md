# –ö–æ–Ω—Ç—Ä–∞–∫—Ç: –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î (Database-Level Business Logic Contract)

**–í–µ—Ä—Å–∏—è:** 1.0  
**–î–∞—Ç–∞:** 2026-01-21  
**–°—Ç–∞—Ç—É—Å:** –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ô –ö –ò–°–ü–û–õ–ù–ï–ù–ò–Æ

---

## ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û

**–í–°–Ø –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞, –æ–ø–∏—Å–∞–Ω–Ω–∞—è –≤ —ç—Ç–æ–º –¥–æ–∫—É–º–µ–Ω—Ç–µ, —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ PostgreSQL —á–µ—Ä–µ–∑ —Ç—Ä–∏–≥–≥–µ—Ä—ã –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è.**

**–ó–ê–ü–†–ï–©–ï–ù–û:**
- ‚ùå –î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å —ç—Ç—É –ª–æ–≥–∏–∫—É –≤ –∫–æ–¥–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (Python/FastAPI)
- ‚ùå –†–µ–∞–ª–∏–∑–æ–≤—ã–≤–∞—Ç—å –∞–Ω–∞–ª–æ–≥–∏—á–Ω—É—é –ª–æ–≥–∏–∫—É –≤ —Å–µ—Ä–≤–∏—Å–∞—Ö –∏–ª–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è—Ö
- ‚ùå –î–æ–±–∞–≤–ª—è—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É–µ—Ç —Å —Ç—Ä–∏–≥–≥–µ—Ä–∞–º–∏ –ë–î
- ‚ùå –û–±—Ö–æ–¥–∏—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä—ã —á–µ—Ä–µ–∑ –ø—Ä—è–º—ã–µ SQL-–∑–∞–ø—Ä–æ—Å—ã –±–µ–∑ —É—á–µ—Ç–∞ –∏—Ö –ª–æ–≥–∏–∫–∏

**–†–ê–ó–†–ï–®–ï–ù–û:**
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä—ã –ë–î –∫–∞–∫ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã
- ‚úÖ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∏—Å–∫–ª—é—á–µ–Ω–∏—è –æ—Ç —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤ (IntegrityError) –∏ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤—ã–≤–∞—Ç—å –∏—Ö –≤ DomainError
- ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–≤–µ–¥–µ–Ω–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤ –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö –∫–æ–¥–∞
- ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–≤–µ–¥–µ–Ω–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤ —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã

---

## üìã –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –≤ –ë–î

### 1. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω—É–º–µ—Ä–∞—Ü–∏—è `order_number` –≤ `user_courses`

**–¢—Ä–∏–≥–≥–µ—Ä:** `trg_set_user_course_order_number`  
**–§—É–Ω–∫—Ü–∏—è:** `set_user_course_order_number()`  
**–¢–∞–±–ª–∏—Ü–∞:** `user_courses`  
**–°–æ–±—ã—Ç–∏—è:** `BEFORE INSERT`, `BEFORE UPDATE`

#### –õ–æ–≥–∏–∫–∞ —Ç—Ä–∏–≥–≥–µ—Ä–∞:

1. **–ü—Ä–∏ INSERT:**
   - –ï—Å–ª–∏ `order_number IS NULL` ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è `MAX(order_number) + 1` –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –ï—Å–ª–∏ `order_number` —É–∫–∞–∑–∞–Ω —è–≤–Ω–æ ‚Üí —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫—É—Ä—Å—ã —Å `order_number >= NEW.order_number` —Å–¥–≤–∏–≥–∞—é—Ç—Å—è –≤–ø—Ä–∞–≤–æ (+1)

2. **–ü—Ä–∏ UPDATE:**
   - –ï—Å–ª–∏ `order_number` –∏–∑–º–µ–Ω–∏–ª—Å—è ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –ø–æ—Ä—è–¥–∫–æ–≤—ã–µ –Ω–æ–º–µ—Ä–∞ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∫—É—Ä—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –ü—Ä–∏ —É–≤–µ–ª–∏—á–µ–Ω–∏–∏ –Ω–æ–º–µ—Ä–∞ ‚Üí –∫—É—Ä—Å—ã –º–µ–∂–¥—É —Å—Ç–∞—Ä—ã–º –∏ –Ω–æ–≤—ã–º –Ω–æ–º–µ—Ä–æ–º —Å–¥–≤–∏–≥–∞—é—Ç—Å—è –≤–ª–µ–≤–æ (-1)
   - –ü—Ä–∏ —É–º–µ–Ω—å—à–µ–Ω–∏–∏ –Ω–æ–º–µ—Ä–∞ ‚Üí –∫—É—Ä—Å—ã –º–µ–∂–¥—É –Ω–æ–≤—ã–º –∏ —Å—Ç–∞—Ä—ã–º –Ω–æ–º–µ—Ä–æ–º —Å–¥–≤–∏–≥–∞—é—Ç—Å—è –≤–ø—Ä–∞–≤–æ (+1)
   - –ï—Å–ª–∏ `order_number` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ `NULL` ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—Ç–∞–≤–∏—Ç—Å—è —Å–ª–µ–¥—É—é—â–∏–π –Ω–æ–º–µ—Ä

#### –ß—Ç–æ –ù–ï –Ω—É–∂–Ω–æ –¥–µ–ª–∞—Ç—å –≤ –∫–æ–¥–µ:

```python
# ‚ùå –ó–ê–ü–†–ï–©–ï–ù–û: –≤—ã—á–∏—Å–ª—è—Ç—å order_number –≤—Ä—É—á–Ω—É—é
max_order = await db.execute(select(func.max(UserCourses.order_number)).where(...))
new_order = (max_order or 0) + 1

# ‚ùå –ó–ê–ü–†–ï–©–ï–ù–û: —Å–¥–≤–∏–≥–∞—Ç—å –∫—É—Ä—Å—ã –≤—Ä—É—á–Ω—É—é –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ order_number
await db.execute(update(UserCourses).where(...).values(order_number=order_number + 1))

# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–¥–∞—Ç—å None –∏–ª–∏ —è–≤–Ω—ã–π –Ω–æ–º–µ—Ä, —Ç—Ä–∏–≥–≥–µ—Ä —Å–¥–µ–ª–∞–µ—Ç –≤—Å–µ —Å–∞–º
await db.execute(insert(UserCourses).values(user_id=1, course_id=2, order_number=None))
```

#### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:

–¢—Ä–∏–≥–≥–µ—Ä –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—à–∏–±–æ–∫, —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç/–ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è.

---

### 2. –ü–µ—Ä–µ—Å—á–µ—Ç `order_number` –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –∫—É—Ä—Å–∞

**–¢—Ä–∏–≥–≥–µ—Ä:** `trg_reorder_after_delete`  
**–§—É–Ω–∫—Ü–∏—è:** `reorder_after_delete()`  
**–¢–∞–±–ª–∏—Ü–∞:** `user_courses`  
**–°–æ–±—ã—Ç–∏—è:** `AFTER DELETE`

#### –õ–æ–≥–∏–∫–∞ —Ç—Ä–∏–≥–≥–µ—Ä–∞:

- –ü–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏ –∏–∑ `user_courses`:
  - –ï—Å–ª–∏ —É —É–¥–∞–ª–µ–Ω–Ω–æ–π –∑–∞–ø–∏—Å–∏ –±—ã–ª `order_number IS NOT NULL`
  - –í—Å–µ –∫—É—Ä—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å `order_number > OLD.order_number` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–¥–≤–∏–≥–∞—é—Ç—Å—è –≤–ª–µ–≤–æ (-1)

#### –ß—Ç–æ –ù–ï –Ω—É–∂–Ω–æ –¥–µ–ª–∞—Ç—å –≤ –∫–æ–¥–µ:

```python
# ‚ùå –ó–ê–ü–†–ï–©–ï–ù–û: –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—Ç—å order_number –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –≤—Ä—É—á–Ω—É—é
await db.delete(user_course)
await db.execute(update(UserCourses).where(...).values(order_number=order_number - 1))

# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: –ø—Ä–æ—Å—Ç–æ —É–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å, —Ç—Ä–∏–≥–≥–µ—Ä –ø–µ—Ä–µ—Å—á–∏—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
await db.delete(user_course)
await db.commit()
```

---

### 3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω—É–º–µ—Ä–∞—Ü–∏—è `order_number` –≤ `course_parents`

**–¢—Ä–∏–≥–≥–µ—Ä:** `trg_set_course_parent_order_number`  
**–§—É–Ω–∫—Ü–∏—è:** `set_course_parent_order_number()`  
**–¢–∞–±–ª–∏—Ü–∞:** `course_parents`  
**–°–æ–±—ã—Ç–∏—è:** `BEFORE INSERT`, `BEFORE UPDATE`

#### –õ–æ–≥–∏–∫–∞ —Ç—Ä–∏–≥–≥–µ—Ä–∞:

1. **–ü—Ä–∏ INSERT:**
   - –ï—Å–ª–∏ `order_number IS NULL` ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è `MAX(order_number) + 1` –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –∫—É—Ä—Å–∞
   - –ï—Å–ª–∏ `order_number` —É–∫–∞–∑–∞–Ω —è–≤–Ω–æ ‚Üí —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–¥–∫—É—Ä—Å—ã —Å `order_number >= NEW.order_number` —Å–¥–≤–∏–≥–∞—é—Ç—Å—è –≤–ø—Ä–∞–≤–æ (+1)

2. **–ü—Ä–∏ UPDATE:**
   - –ï—Å–ª–∏ `order_number` –∏–∑–º–µ–Ω–∏–ª—Å—è ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –ø–æ—Ä—è–¥–∫–æ–≤—ã–µ –Ω–æ–º–µ—Ä–∞ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –ø–æ–¥–∫—É—Ä—Å–æ–≤ —Ä–æ–¥–∏—Ç–µ–ª—è
   - –ü—Ä–∏ —É–≤–µ–ª–∏—á–µ–Ω–∏–∏ –Ω–æ–º–µ—Ä–∞ ‚Üí –ø–æ–¥–∫—É—Ä—Å—ã –º–µ–∂–¥—É —Å—Ç–∞—Ä—ã–º –∏ –Ω–æ–≤—ã–º –Ω–æ–º–µ—Ä–æ–º —Å–¥–≤–∏–≥–∞—é—Ç—Å—è –≤–ª–µ–≤–æ (-1)
   - –ü—Ä–∏ —É–º–µ–Ω—å—à–µ–Ω–∏–∏ –Ω–æ–º–µ—Ä–∞ ‚Üí –ø–æ–¥–∫—É—Ä—Å—ã –º–µ–∂–¥—É –Ω–æ–≤—ã–º –∏ —Å—Ç–∞—Ä—ã–º –Ω–æ–º–µ—Ä–æ–º —Å–¥–≤–∏–≥–∞—é—Ç—Å—è –≤–ø—Ä–∞–≤–æ (+1)
   - –ï—Å–ª–∏ `order_number` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ `NULL` ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—Ç–∞–≤–∏—Ç—Å—è —Å–ª–µ–¥—É—é—â–∏–π –Ω–æ–º–µ—Ä

#### –ß—Ç–æ –ù–ï –Ω—É–∂–Ω–æ –¥–µ–ª–∞—Ç—å –≤ –∫–æ–¥–µ:

```python
# ‚ùå –ó–ê–ü–†–ï–©–ï–ù–û: –≤—ã—á–∏—Å–ª—è—Ç—å order_number –≤—Ä—É—á–Ω—É—é
max_order = await db.execute(select(func.max(t_course_parents.c.order_number)).where(...))
new_order = (max_order or 0) + 1

# ‚ùå –ó–ê–ü–†–ï–©–ï–ù–û: —Å–¥–≤–∏–≥–∞—Ç—å –ø–æ–¥–∫—É—Ä—Å—ã –≤—Ä—É—á–Ω—É—é –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ order_number
await db.execute(update(t_course_parents).where(...).values(order_number=order_number + 1))

# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–¥–∞—Ç—å None –∏–ª–∏ —è–≤–Ω—ã–π –Ω–æ–º–µ—Ä, —Ç—Ä–∏–≥–≥–µ—Ä —Å–¥–µ–ª–∞–µ—Ç –≤—Å–µ —Å–∞–º
await db.execute(insert(t_course_parents).values(course_id=1, parent_course_id=2, order_number=None))
```

#### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:

–¢—Ä–∏–≥–≥–µ—Ä –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—à–∏–±–æ–∫, —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç/–ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è.

---

### 4. –ü–µ—Ä–µ—Å—á–µ—Ç `order_number` –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–¥–∫—É—Ä—Å–∞

**–¢—Ä–∏–≥–≥–µ—Ä:** `trg_reorder_course_parents_after_delete`  
**–§—É–Ω–∫—Ü–∏—è:** `reorder_course_parents_after_delete()`  
**–¢–∞–±–ª–∏—Ü–∞:** `course_parents`  
**–°–æ–±—ã—Ç–∏—è:** `AFTER DELETE`

#### –õ–æ–≥–∏–∫–∞ —Ç—Ä–∏–≥–≥–µ—Ä–∞:

- –ü–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏ –∏–∑ `course_parents`:
  - –ï—Å–ª–∏ —É —É–¥–∞–ª–µ–Ω–Ω–æ–π –∑–∞–ø–∏—Å–∏ –±—ã–ª `order_number IS NOT NULL`
  - –í—Å–µ –ø–æ–¥–∫—É—Ä—Å—ã —Ä–æ–¥–∏—Ç–µ–ª—è —Å `order_number > OLD.order_number` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–¥–≤–∏–≥–∞—é—Ç—Å—è –≤–ª–µ–≤–æ (-1)

#### –ß—Ç–æ –ù–ï –Ω—É–∂–Ω–æ –¥–µ–ª–∞—Ç—å –≤ –∫–æ–¥–µ:

```python
# ‚ùå –ó–ê–ü–†–ï–©–ï–ù–û: –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—Ç—å order_number –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –≤—Ä—É—á–Ω—É—é
await db.delete(course_parent_link)
await db.execute(update(t_course_parents).where(...).values(order_number=order_number - 1))

# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: –ø—Ä–æ—Å—Ç–æ —É–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å, —Ç—Ä–∏–≥–≥–µ—Ä –ø–µ—Ä–µ—Å—á–∏—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
await db.delete(course_parent_link)
await db.commit()
```

---

### 5. –í–∞–ª–∏–¥–∞—Ü–∏—è —Ü–∏–∫–ª–æ–≤ –≤ –∏–µ—Ä–∞—Ä—Ö–∏–∏ –∫—É—Ä—Å–æ–≤

**–¢—Ä–∏–≥–≥–µ—Ä:** `trg_check_course_hierarchy_cycle`  
**–§—É–Ω–∫—Ü–∏—è:** `check_course_hierarchy_cycle()`  
**–¢–∞–±–ª–∏—Ü–∞:** `course_parents`  
**–°–æ–±—ã—Ç–∏—è:** `BEFORE INSERT`, `BEFORE UPDATE`

#### –õ–æ–≥–∏–∫–∞ —Ç—Ä–∏–≥–≥–µ—Ä–∞:

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∞–º–æ—Å—Å—ã–ª–∫–∏:**
   - –ï—Å–ª–∏ `NEW.course_id = NEW.parent_course_id` ‚Üí `RAISE EXCEPTION 'Course cannot be its own parent'`

2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–∏–∫–ª–æ–≤:**
   - –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—Å—é —Ü–µ–ø–æ—á–∫—É –ø—Ä–µ–¥–∫–æ–≤ –∫—É—Ä—Å–∞ —á–µ—Ä–µ–∑ —Ç–∞–±–ª–∏—Ü—É `course_parents`
   - –ï—Å–ª–∏ –∫—É—Ä—Å —è–≤–ª—è–µ—Ç—Å—è –ø–æ—Ç–æ–º–∫–æ–º —Å–≤–æ–µ–≥–æ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–≥–æ —Ä–æ–¥–∏—Ç–µ–ª—è ‚Üí `RAISE EXCEPTION 'Circular reference detected'`

#### –ß—Ç–æ –ù–ï –Ω—É–∂–Ω–æ –¥–µ–ª–∞—Ç—å –≤ –∫–æ–¥–µ:

```python
# ‚ùå –ó–ê–ü–†–ï–©–ï–ù–û: –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Ü–∏–∫–ª—ã –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ —Ä–µ–∫—É—Ä—Å–∏–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
async def check_cycle(course_id, parent_id):
    # –†–µ–∫—É—Ä—Å–∏–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞...
    pass

# ‚ùå –ó–ê–ü–†–ï–©–ï–ù–û: –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å —Å–∞–º–æ—Å—Å—ã–ª–∫–∏ –≤—Ä—É—á–Ω—É—é
if course_id == parent_id:
    raise DomainError("Self-reference not allowed")

# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: –ø—Ä–æ—Å—Ç–æ –≤—Å—Ç–∞–≤–∏—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å —Å–≤—è–∑—å, —Ç—Ä–∏–≥–≥–µ—Ä –ø—Ä–æ–≤–µ—Ä–∏—Ç –≤—Å–µ —Å–∞–º
try:
    await db.execute(insert(t_course_parents).values(course_id=1, parent_course_id=2))
    await db.commit()
except IntegrityError as e:
    # –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ—à–∏–±–∫—É –æ—Ç —Ç—Ä–∏–≥–≥–µ—Ä–∞
    if "Circular reference" in str(e):
        raise DomainError("Cycle detected", status_code=400)
```

#### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:

–¢—Ä–∏–≥–≥–µ—Ä –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç `IntegrityError` —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏:
- `'Course cannot be its own parent'` ‚Üí –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –≤ `DomainError` —Å –∫–æ–¥–æ–º 400
- `'Circular reference detected: course X cannot be a descendant of course Y'` ‚Üí –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –≤ `DomainError` —Å –∫–æ–¥–æ–º 400

---

### 6. –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ —Å–∞–º–æ—Å—Å—ã–ª–æ–∫ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è—Ö –∫—É—Ä—Å–æ–≤

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ:** `check_no_self_dependency`  
**–¢–∞–±–ª–∏—Ü–∞:** `course_dependencies`  
**–¢–∏–ø:** `CHECK CONSTRAINT`

#### –õ–æ–≥–∏–∫–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:

- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ `course_id != required_course_id`
- –ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ —Å–æ–∑–¥–∞—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –∫—É—Ä—Å–∞ –æ—Ç —Å–∞–º–æ–≥–æ —Å–µ–±—è ‚Üí PostgreSQL –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç `IntegrityError`

#### –ß—Ç–æ –ù–ï –Ω—É–∂–Ω–æ –¥–µ–ª–∞—Ç—å –≤ –∫–æ–¥–µ:

```python
# ‚ùå –ó–ê–ü–†–ï–©–ï–ù–û: –ø—Ä–æ–≤–µ—Ä—è—Ç—å self-dependency –≤—Ä—É—á–Ω—É—é
if course_id == required_course_id:
    raise DomainError("Self-dependency not allowed")

# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ë–î —Å–∞–º–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç
try:
    await db.execute(insert(course_dependencies).values(...))
    await db.commit()
except IntegrityError as e:
    if "check_no_self_dependency" in str(e):
        raise DomainError("Self-dependency not allowed", status_code=400)
```

#### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:

PostgreSQL –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç `IntegrityError` –ø—Ä–∏ –Ω–∞—Ä—É—à–µ–Ω–∏–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è. –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –≤ `DomainError` —Å –∫–æ–¥–æ–º 400.

---

## üîí –ü—Ä–∞–≤–∏–ª–∞ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞:

1. **–ü–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤ –∫–æ–¥:**
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —ç—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ–π –ª–æ–≥–∏–∫–∏ –≤ –ë–î
   - –ï—Å–ª–∏ –ª–æ–≥–∏–∫–∞ –µ—Å—Ç—å –≤ –ë–î ‚Üí –ù–ï –¥–æ–±–∞–≤–ª—è—Ç—å –≤ –∫–æ–¥, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä—ã

2. **–ü—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å `order_number` –≤ `user_courses`:**
   - –í—Å–µ–≥–¥–∞ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å `None` ‚Üí —Ç—Ä–∏–≥–≥–µ—Ä —É—Å—Ç–∞–Ω–æ–≤–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
   - –ú–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å —è–≤–Ω—ã–π –Ω–æ–º–µ—Ä ‚Üí —Ç—Ä–∏–≥–≥–µ—Ä –ø–µ—Ä–µ—Å—á–∏—Ç–∞–µ—Ç –æ—Å—Ç–∞–ª—å–Ω—ã–µ
   - –ù–ï –Ω—É–∂–Ω–æ –≤—ã—á–∏—Å–ª—è—Ç—å `order_number` –≤—Ä—É—á–Ω—É—é –ø–µ—Ä–µ–¥ INSERT

3. **–ü—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å `order_number` –≤ `course_parents`:**
   - –í—Å–µ–≥–¥–∞ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å `None` ‚Üí —Ç—Ä–∏–≥–≥–µ—Ä —É—Å—Ç–∞–Ω–æ–≤–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
   - –ú–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å —è–≤–Ω—ã–π –Ω–æ–º–µ—Ä ‚Üí —Ç—Ä–∏–≥–≥–µ—Ä –ø–µ—Ä–µ—Å—á–∏—Ç–∞–µ—Ç –æ—Å—Ç–∞–ª—å–Ω—ã–µ
   - –ù–ï –Ω—É–∂–Ω–æ –≤—ã—á–∏—Å–ª—è—Ç—å `order_number` –≤—Ä—É—á–Ω—É—é –ø–µ—Ä–µ–¥ INSERT
   - –ü–æ—Ä—è–¥–æ–∫ –ø–æ–¥–∫—É—Ä—Å–æ–≤ –≤–Ω—É—Ç—Ä–∏ —Ä–æ–¥–∏—Ç–µ–ª—è —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

4. **–ü—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –∏–µ—Ä–∞—Ä—Ö–∏–µ–π –∫—É—Ä—Å–æ–≤:**
   - –ù–ï –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Ü–∏–∫–ª—ã –≤—Ä—É—á–Ω—É—é
   - –ü—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–∏—Ç—å `parent_course_ids` ‚Üí —Ç—Ä–∏–≥–≥–µ—Ä –ø—Ä–æ–≤–µ—Ä–∏—Ç —Ü–∏–∫–ª—ã
   - –û–±—Ä–∞–±–æ—Ç–∞—Ç—å `IntegrityError` –æ—Ç —Ç—Ä–∏–≥–≥–µ—Ä–∞ –∏ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –≤ `DomainError`

5. **–ü—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏ –∫—É—Ä—Å–æ–≤:**
   - –ù–ï –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å self-dependency –≤—Ä—É—á–Ω—É—é
   - –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ë–î —Å–∞–º–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç
   - –û–±—Ä–∞–±–æ—Ç–∞—Ç—å `IntegrityError` –∏ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –≤ `DomainError`

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –ø—Ä–∞–∫—Ç–∏–∫–∏:

1. **–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤:**
   ```python
   # –ü–æ—Ä—è–¥–∫–æ–≤—ã–π –Ω–æ–º–µ—Ä —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ç—Ä–∏–≥–≥–µ—Ä–æ–º –ë–î, –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω
   order_number: Optional[int] = None
   ```

2. **–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –æ—à–∏–±–∫–∏ –æ—Ç —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤:**
   ```python
   try:
       await db.commit()
   except IntegrityError as e:
       if "Circular reference" in str(e):
           raise DomainError("Cycle detected", status_code=400)
   ```

3. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–≤–µ–¥–µ–Ω–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤:**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ–≤–µ—Ä—è—é—Ç —Ä–µ–∞–ª—å–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ë–î
   - –ù–µ –º–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä—ã –≤ —Ç–µ—Å—Ç–∞—Ö

---

## üìù –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π

| –¢—Ä–∏–≥–≥–µ—Ä/–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ | –¢–∞–±–ª–∏—Ü–∞ | –°–æ–±—ã—Ç–∏–µ | –§—É–Ω–∫—Ü–∏—è | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------------------|---------|---------|---------|----------|
| `trg_set_user_course_order_number` | `user_courses` | BEFORE INSERT/UPDATE | `set_user_course_order_number()` | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω—É–º–µ—Ä–∞—Ü–∏—è –∏ –ø–µ—Ä–µ—Å—á–µ—Ç order_number |
| `trg_reorder_after_delete` | `user_courses` | AFTER DELETE | `reorder_after_delete()` | –ü–µ—Ä–µ—Å—á–µ—Ç order_number –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è |
| `trg_check_course_hierarchy_cycle` | `courses` | BEFORE INSERT/UPDATE | `check_course_hierarchy_cycle()` | –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–∏–∫–ª–æ–≤ –≤ –∏–µ—Ä–∞—Ä—Ö–∏–∏ –∫—É—Ä—Å–æ–≤ |
| `check_no_self_dependency` | `course_dependencies` | CHECK CONSTRAINT | - | –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ —Å–∞–º–æ—Å—Å—ã–ª–æ–∫ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è—Ö |
| `trg_set_course_parent_order_number` | `course_parents` | BEFORE INSERT/UPDATE | `set_course_parent_order_number()` | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω—É–º–µ—Ä–∞—Ü–∏—è –∏ –ø–µ—Ä–µ—Å—á–µ—Ç order_number –¥–ª—è –ø–æ–¥–∫—É—Ä—Å–æ–≤ |
| `trg_reorder_course_parents_after_delete` | `course_parents` | AFTER DELETE | `reorder_course_parents_after_delete()` | –ü–µ—Ä–µ—Å—á–µ—Ç order_number –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–¥–∫—É—Ä—Å–∞ |
| `trg_check_teacher_course_no_parents` | `teacher_courses` | BEFORE INSERT | `check_course_has_no_parents()` | –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –∫—É—Ä—Å –Ω–µ –∏–º–µ–µ—Ç —Ä–æ–¥–∏—Ç–µ–ª–µ–π –ø–µ—Ä–µ–¥ –ø—Ä–∏–≤—è–∑–∫–æ–π –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è |
| `trg_check_user_course_no_parents` | `user_courses` | BEFORE INSERT | `check_user_course_has_no_parents()` | –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –∫—É—Ä—Å –Ω–µ –∏–º–µ–µ—Ç —Ä–æ–¥–∏—Ç–µ–ª–µ–π –ø–µ—Ä–µ–¥ –ø—Ä–∏–≤—è–∑–∫–æ–π —Å—Ç—É–¥–µ–Ω—Ç–∞ |

---

### 6. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–∏–≤—è–∑–∫–∞ –¥–µ—Ç–µ–π –ø—Ä–∏ –ø—Ä–∏–≤—è–∑–∫–µ —Ä–æ–¥–∏—Ç–µ–ª—è –∫ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—é

**–¢—Ä–∏–≥–≥–µ—Ä:** `trg_auto_link_teacher_course_children`  
**–§—É–Ω–∫—Ü–∏—è:** `auto_link_teacher_course_children()`  
**–¢–∞–±–ª–∏—Ü–∞:** `teacher_courses`  
**–°–æ–±—ã—Ç–∏—è:** `AFTER INSERT`

#### –õ–æ–≥–∏–∫–∞ —Ç—Ä–∏–≥–≥–µ—Ä–∞:

1. –ü—Ä–∏ –ø—Ä–∏–≤—è–∑–∫–µ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è –∫ –∫—É—Ä—Å—É (INSERT –≤ `teacher_courses`):
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤—Å–µ –ø–æ—Ç–æ–º–∫–∏ –∫—É—Ä—Å–∞ —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ (—Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º –≥–ª—É–±–∏–Ω—ã 20 —É—Ä–æ–≤–Ω–µ–π)
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è —Å–≤—è–∑–∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è —Å–æ –≤—Å–µ–º–∏ –ø–æ—Ç–æ–º–∫–∞–º–∏
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `ON CONFLICT DO NOTHING` –¥–ª—è –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏

#### –ß—Ç–æ –ù–ï –Ω—É–∂–Ω–æ –¥–µ–ª–∞—Ç—å –≤ –∫–æ–¥–µ:

```python
# ‚ùå –ó–ê–ü–†–ï–©–ï–ù–û: –≤—Ä—É—á–Ω—É—é –ø—Ä–∏–≤—è–∑—ã–≤–∞—Ç—å –¥–µ—Ç–µ–π –ø—Ä–∏ –ø—Ä–∏–≤—è–∑–∫–µ —Ä–æ–¥–∏—Ç–µ–ª—è
await teacher_courses_repo.add(db, teacher_id=16, course_id=1)
# –í—Ä—É—á–Ω—É—é –Ω–∞—Ö–æ–¥–∏—Ç—å –∏ –ø—Ä–∏–≤—è–∑—ã–≤–∞—Ç—å –¥–µ—Ç–µ–π
children = await courses_repo.get_all_children(db, course_id=1)
for child in children:
    await teacher_courses_repo.add(db, teacher_id=16, course_id=child.id)

# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: –ø—Ä–æ—Å—Ç–æ –ø—Ä–∏–≤—è–∑–∞—Ç—å —Ä–æ–¥–∏—Ç–µ–ª—è, —Ç—Ä–∏–≥–≥–µ—Ä –ø—Ä–∏–≤—è–∂–µ—Ç –¥–µ—Ç–µ–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
await teacher_courses_repo.add(db, teacher_id=16, course_id=1)
```

#### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:

–¢—Ä–∏–≥–≥–µ—Ä –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—à–∏–±–æ–∫, —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç —Å–≤—è–∑–∏.

---

### 7. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–≤—è–∑–∫–∞ –¥–µ—Ç–µ–π –ø—Ä–∏ –æ—Ç–≤—è–∑–∫–µ —Ä–æ–¥–∏—Ç–µ–ª—è –æ—Ç –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è

**–¢—Ä–∏–≥–≥–µ—Ä:** `trg_auto_unlink_teacher_course_children`  
**–§—É–Ω–∫—Ü–∏—è:** `auto_unlink_teacher_course_children()`  
**–¢–∞–±–ª–∏—Ü–∞:** `teacher_courses`  
**–°–æ–±—ã—Ç–∏—è:** `AFTER DELETE`

#### –õ–æ–≥–∏–∫–∞ —Ç—Ä–∏–≥–≥–µ—Ä–∞:

1. –ü—Ä–∏ –æ—Ç–≤—è–∑–∫–µ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è –æ—Ç –∫—É—Ä—Å–∞ (DELETE –∏–∑ `teacher_courses`):
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤—Å–µ –ø–æ—Ç–æ–º–∫–∏ –∫—É—Ä—Å–∞ —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ (—Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º –≥–ª—É–±–∏–Ω—ã 20 —É—Ä–æ–≤–Ω–µ–π)
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è—é—Ç—Å—è —Å–≤—è–∑–∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è —Å–æ –≤—Å–µ–º–∏ –ø–æ—Ç–æ–º–∫–∞–º–∏

#### –ß—Ç–æ –ù–ï –Ω—É–∂–Ω–æ –¥–µ–ª–∞—Ç—å –≤ –∫–æ–¥–µ:

```python
# ‚ùå –ó–ê–ü–†–ï–©–ï–ù–û: –≤—Ä—É—á–Ω—É—é –æ—Ç–≤—è–∑—ã–≤–∞—Ç—å –¥–µ—Ç–µ–π –ø—Ä–∏ –æ—Ç–≤—è–∑–∫–µ —Ä–æ–¥–∏—Ç–µ–ª—è
await teacher_courses_repo.remove(db, teacher_id=16, course_id=1)
# –í—Ä—É—á–Ω—É—é –Ω–∞—Ö–æ–¥–∏—Ç—å –∏ –æ—Ç–≤—è–∑—ã–≤–∞—Ç—å –¥–µ—Ç–µ–π
children = await courses_repo.get_all_children(db, course_id=1)
for child in children:
    await teacher_courses_repo.remove(db, teacher_id=16, course_id=child.id)

# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: –ø—Ä–æ—Å—Ç–æ –æ—Ç–≤—è–∑–∞—Ç—å —Ä–æ–¥–∏—Ç–µ–ª—è, —Ç—Ä–∏–≥–≥–µ—Ä –æ—Ç–≤—è–∂–µ—Ç –¥–µ—Ç–µ–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
await teacher_courses_repo.remove(db, teacher_id=16, course_id=1)
```

#### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:

–¢—Ä–∏–≥–≥–µ—Ä –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—à–∏–±–æ–∫, —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ—Ç —Å–≤—è–∑–∏.

---

### 8. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ä–µ–±–µ–Ω–∫–∞ –≤ –∏–µ—Ä–∞—Ä—Ö–∏—é

**–¢—Ä–∏–≥–≥–µ—Ä:** `trg_sync_teacher_courses_on_child_added`  
**–§—É–Ω–∫—Ü–∏—è:** `sync_teacher_courses_on_child_added()`  
**–¢–∞–±–ª–∏—Ü–∞:** `course_parents`  
**–°–æ–±—ã—Ç–∏—è:** `AFTER INSERT`

#### –õ–æ–≥–∏–∫–∞ —Ç—Ä–∏–≥–≥–µ—Ä–∞:

1. –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ä–µ–±–µ–Ω–∫–∞ –∫ —Ä–æ–¥–∏—Ç–µ–ª—é (INSERT –≤ `course_parents`):
   - –ù–∞—Ö–æ–¥—è—Ç—Å—è –≤—Å–µ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–∏, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–µ –∫ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–º—É –∫—É—Ä—Å—É
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è —Å–≤—è–∑–∏ —ç—Ç–∏—Ö –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π —Å –Ω–æ–≤—ã–º —Ä–µ–±–µ–Ω–∫–æ–º
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è —Å–≤—è–∑–∏ —Å–æ –≤—Å–µ–º–∏ –ø–æ—Ç–æ–º–∫–∞–º–∏ –Ω–æ–≤–æ–≥–æ —Ä–µ–±–µ–Ω–∫–∞ (—Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ)

#### –ß—Ç–æ –ù–ï –Ω—É–∂–Ω–æ –¥–µ–ª–∞—Ç—å –≤ –∫–æ–¥–µ:

```python
# ‚ùå –ó–ê–ü–†–ï–©–ï–ù–û: –≤—Ä—É—á–Ω—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–≤—è–∑–∏ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ä–µ–±–µ–Ω–∫–∞
await courses_repo.add_child(db, course_id=10, parent_id=1)
# –í—Ä—É—á–Ω—É—é –Ω–∞—Ö–æ–¥–∏—Ç—å –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π –∏ –ø—Ä–∏–≤—è–∑—ã–≤–∞—Ç—å –∫ —Ä–µ–±–µ–Ω–∫—É
teachers = await teacher_courses_repo.get_teachers_by_course(db, course_id=1)
for teacher_id in teachers:
    await teacher_courses_repo.add(db, teacher_id=teacher_id, course_id=10)

# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–∏—Ç—å —Ä–µ–±–µ–Ω–∫–∞, —Ç—Ä–∏–≥–≥–µ—Ä —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç —Å–≤—è–∑–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
await courses_repo.add_child(db, course_id=10, parent_id=1)
```

#### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:

–¢—Ä–∏–≥–≥–µ—Ä –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—à–∏–±–æ–∫, —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç —Å–≤—è–∑–∏.

---

### 9. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ä–µ–±–µ–Ω–∫–∞ –∏–∑ –∏–µ—Ä–∞—Ä—Ö–∏–∏

**‚ö†Ô∏è –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ô –î–û–õ–ì:** –≠—Ç–∞ –ª–æ–≥–∏–∫–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ –∫–æ–¥–µ, –∞ –Ω–µ –≤ —Ç—Ä–∏–≥–≥–µ—Ä–µ –ë–î.

**–ü—Ä–∏—á–∏–Ω–∞:** PostgreSQL –Ω–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏–∑–º–µ–Ω—è—Ç—å —Ç–∞–±–ª–∏—Ü—É `teacher_courses` –≤ AFTER DELETE —Ç—Ä–∏–≥–≥–µ—Ä–µ –Ω–∞ `course_parents`, –µ—Å–ª–∏ `teacher_courses` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∑–∞–ø—Ä–æ—Å–µ —Ç—Ä–∏–≥–≥–µ—Ä–∞ (–æ—à–∏–±–∫–∞ `TriggeredDataChangeViolationError`).

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:** `TeacherCoursesRepository.sync_on_child_removed()`

#### –õ–æ–≥–∏–∫–∞:

1. –ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ä–µ–±–µ–Ω–∫–∞ –∏–∑ –∏–µ—Ä–∞—Ä—Ö–∏–∏ (DELETE –∏–∑ `course_parents`):
   - –ù–∞—Ö–æ–¥—è—Ç—Å—è –≤—Å–µ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–∏, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–µ –∫ —É–¥–∞–ª—è–µ–º–æ–º—É —Ä–æ–¥–∏—Ç–µ–ª—é
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, –µ—Å—Ç—å –ª–∏ —É –∫—É—Ä—Å–∞ –¥—Ä—É–≥–∏–µ —Ä–æ–¥–∏—Ç–µ–ª–∏
   - –ï—Å–ª–∏ –µ—Å—Ç—å –¥—Ä—É–≥–∏–µ —Ä–æ–¥–∏—Ç–µ–ª–∏ - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, –ø—Ä–∏–≤—è–∑–∞–Ω—ã –ª–∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–∏ –∫ –Ω–∏–º
   - –£–¥–∞–ª—è—é—Ç—Å—è —Å–≤—è–∑–∏ –¥–ª—è –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ –¥—Ä—É–≥–∏–º —Ä–æ–¥–∏—Ç–µ–ª—è–º
   - –£–¥–∞–ª—è—é—Ç—Å—è —Å–≤—è–∑–∏ –¥–ª—è –≤—Å–µ—Ö –ø–æ—Ç–æ–º–∫–æ–≤ —É–¥–∞–ª—è–µ–º–æ–≥–æ —Ä–µ–±–µ–Ω–∫–∞

#### –ß—Ç–æ –ù–ï –Ω—É–∂–Ω–æ –¥–µ–ª–∞—Ç—å –≤ –∫–æ–¥–µ:

```python
# ‚ùå –ó–ê–ü–†–ï–©–ï–ù–û: –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ä–µ–±–µ–Ω–∫–∞
await courses_repo.remove_child(db, course_id=10, parent_id=1)
# –°–≤—è–∑–∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π –æ—Å—Ç–∞–Ω—É—Ç—Å—è –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏

# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: –≤—ã–∑–≤–∞—Ç—å –º–µ—Ç–æ–¥ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è
await courses_repo.remove_child(db, course_id=10, parent_id=1)
teacher_courses_repo = TeacherCoursesRepository()
await teacher_courses_repo.sync_on_child_removed(db, removed_course_id=10, removed_parent_id=1)
```

**‚ö†Ô∏è –í–ê–ñ–ù–û:** –≠—Ç–æ—Ç –º–µ—Ç–æ–¥ –¥–æ–ª–∂–µ–Ω –≤—ã–∑—ã–≤–∞—Ç—å—Å—è –≤ —Å–µ—Ä–≤–∏—Å–µ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–≤—è–∑–∏ –≤ `course_parents`.  
**‚ö†Ô∏è –ü–õ–ê–ù:** –í –±—É–¥—É—â–µ–º –º–æ–∂–Ω–æ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ DEFERRED —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤ –∏–ª–∏ –¥—Ä—É–≥–∏—Ö –ø–æ–¥—Ö–æ–¥–æ–≤ –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞ –ª–æ–≥–∏–∫–∏ –æ–±—Ä–∞—Ç–Ω–æ –≤ –ë–î.

---

## üîç –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤

```sql
-- –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤
SELECT 
    trigger_name, 
    event_object_table, 
    action_statement,
    action_timing,
    event_manipulation
FROM information_schema.triggers 
WHERE trigger_schema = 'public'
ORDER BY event_object_table, trigger_name;

-- –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö CHECK –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
SELECT 
    constraint_name,
    table_name,
    check_clause
FROM information_schema.check_constraints
WHERE constraint_schema = 'public';
```

---

## üìö –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- [–ú–∏–≥—Ä–∞—Ü–∏—è —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤](../app/db/migrations/versions/20250101_000000_add_courses_triggers.py)
- [Smoke —Ç–µ—Å—Ç—ã —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤](../tests/test_triggers_smoke.py)
- [API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∫—É—Ä—Å–æ–≤](courses-api.md)

---

## ‚öñÔ∏è –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å

**–ù–∞—Ä—É—à–µ–Ω–∏–µ —ç—Ç–æ–≥–æ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫:**
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—é –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏
- –ö–æ–Ω—Ñ–ª–∏–∫—Ç–∞–º –º–µ–∂–¥—É –ª–æ–≥–∏–∫–æ–π –ë–î –∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- –ù–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–º—É –ø–æ–≤–µ–¥–µ–Ω–∏—é —Å–∏—Å—Ç–µ–º—ã
- –°–ª–æ–∂–Ω–æ—Å—Ç—è–º –≤ –ø–æ–¥–¥–µ—Ä–∂–∫–µ –∏ –æ—Ç–ª–∞–¥–∫–µ

**–ü—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –Ω–∞—Ä—É—à–µ–Ω–∏—è:**
1. –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥, —É–¥–∞–ª–∏–≤ –¥—É–±–ª–∏—Ä—É—é—â—É—é –ª–æ–≥–∏–∫—É
2. –û–±–Ω–æ–≤–∏—Ç—å —ç—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç, –µ—Å–ª–∏ –ª–æ–≥–∏–∫–∞ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å
3. –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã, –ø—Ä–æ–≤–µ—Ä—è—é—â–∏–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2026-01-27  
**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π:** –ö–æ–º–∞–Ω–¥–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ LMS

---

## üìù –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

### 2026-01-27: –£–ø—Ä–æ—â–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ —Ä–∞–±–æ—Ç—ã —Å —Ç—Ä–∏–≥–≥–µ—Ä–∞–º–∏

**–£–¥–∞–ª–µ–Ω–æ:**
- –¢—Ä–∏–≥–≥–µ—Ä—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø—Ä–∏–≤—è–∑–∫–∏/–æ—Ç–≤—è–∑–∫–∏ –¥–µ—Ç–µ–π (`trg_auto_link_teacher_course_children`, `trg_auto_unlink_teacher_course_children`)
- –¢—Ä–∏–≥–≥–µ—Ä —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ä–µ–±–µ–Ω–∫–∞ (`trg_sync_teacher_courses_on_child_added`)
- –ú–µ—Ç–æ–¥ `sync_on_child_removed` –∏–∑ `TeacherCoursesRepository`

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
- –¢—Ä–∏–≥–≥–µ—Ä—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è —Ä–æ–¥–∏—Ç–µ–ª–µ–π –ø–µ—Ä–µ–¥ –ø—Ä–∏–≤—è–∑–∫–æ–π (`trg_check_teacher_course_no_parents`, `trg_check_user_course_no_parents`)

**–ù–æ–≤—ã–µ –ø—Ä–∞–≤–∏–ª–∞:**
- –ü—Ä–∏–≤—è–∑–∫–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π –∏ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –≤–æ–∑–º–æ–∂–Ω–∞ —Ç–æ–ª—å–∫–æ –∫ –∫—É—Ä—Å–∞–º –±–µ–∑ —Ä–æ–¥–∏—Ç–µ–ª–µ–π (–∫–æ—Ä–Ω–µ–≤—ã–º –∫—É—Ä—Å–∞–º)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∏–µ—Ä–∞—Ä—Ö–∏–∏ –∫—É—Ä—Å–æ–≤ –±–æ–ª—å—à–µ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è
