# Руководство для разработчиков (Contributing Guide)

## ⚠️ КРИТИЧЕСКИ ВАЖНО: Бизнес-логика в БД

**Перед добавлением любой бизнес-логики в код приложения:**

1. **ОБЯЗАТЕЛЬНО** прочитайте **[docs/database-triggers-contract.md](docs/database-triggers-contract.md)**
2. Проверьте, не реализована ли эта логика уже в БД через триггеры или ограничения
3. Если логика есть в БД → **НЕ ДУБЛИРУЙТЕ** её в коде приложения

### Что реализовано в БД:

- ✅ Автоматическая нумерация `order_number` в `user_courses`
- ✅ Пересчет `order_number` после удаления курса
- ✅ Валидация циклов в иерархии курсов
- ✅ Предотвращение самоссылок в зависимостях курсов

**Подробности:** см. [docs/database-triggers-contract.md](docs/database-triggers-contract.md)

---

## Правила разработки

### 1. Работа с базой данных

- Используйте миграции Alembic для всех изменений схемы БД
- Не изменяйте БД напрямую без миграций
- Тестируйте миграции на тестовой БД перед применением к production

### 2. Структура кода

- **Модели** (`app/models/`) - только структура данных, без бизнес-логики
- **Репозитории** (`app/repos/`) - доступ к данным, без бизнес-логики
- **Сервисы** (`app/services/`) - бизнес-логика (но НЕ та, что в БД!)
- **API** (`app/api/`) - эндпойнты, валидация запросов

### 3. Обработка ошибок

- Используйте `DomainError` для бизнес-ошибок
- Обрабатывайте `IntegrityError` от триггеров БД и преобразуйте в `DomainError`
- Всегда указывайте правильные HTTP статус-коды

### 4. Тестирование

- Пишите smoke-тесты для новых эндпойнтов
- Тестируйте поведение триггеров БД через интеграционные тесты
- Не мокируйте триггеры БД в тестах

### 5. Документация

- Обновляйте Swagger документацию для всех новых эндпойнтов
- Добавляйте примеры запросов и ответов
- Документируйте использование триггеров БД в комментариях кода

---

## Процесс разработки

1. Создайте ветку от `main`
2. Реализуйте изменения
3. Обновите документацию (если нужно)
4. Напишите тесты
5. Проверьте, что не нарушаете контракт БД-триггеров
6. Создайте Pull Request

---

## Полезные ссылки

- [Контракт БД-триггеров](docs/database-triggers-contract.md)
- [API документация курсов](docs/courses-api.md)
- [Миграции БД](app/db/migrations/)
